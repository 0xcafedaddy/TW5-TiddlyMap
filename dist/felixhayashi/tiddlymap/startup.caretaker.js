/*\

title: $:/plugins/felixhayashi/tiddlymap/caretaker.js
type: application/javascript
module-type: startup

@module TiddlyMap
@preserve

\*/
(function(){"use strict";exports.name="tmap.caretaker";exports.platforms=["browser"];exports.after=["startup"];exports.before=["rootwidget"];exports.synchronous=true;var e=require("$:/plugins/felixhayashi/tiddlymap/utils.js").utils;var t=require("$:/plugins/felixhayashi/tiddlymap/adapter.js").Adapter;var i=require("$:/plugins/felixhayashi/tiddlymap/dialog_manager.js").DialogManager;var a=require("$:/plugins/felixhayashi/tiddlymap/callback_manager.js").CallbackManager;var s=require("$:/plugins/felixhayashi/vis/vis.js");var r=function(t){var i=t;if(!i.path)i.path=e.getDataMap();i.path.pluginRoot="$:/plugins/felixhayashi/tiddlymap";i.path.edgeTypes="$:/plugins/felixhayashi/tiddlymap/graph/edgeTypes";i.path.listEdgeTypes="$:/plugins/felixhayashi/tiddlymap/graph/edgeTypes/tw-list:";i.path.fieldEdgeTypes="$:/plugins/felixhayashi/tiddlymap/graph/edgeTypes/tw-field:";i.path.views="$:/plugins/felixhayashi/tiddlymap/graph/views";i.path.options="$:/plugins/felixhayashi/tiddlymap/config";i.path.tempRoot="$:/temp/felixhayashi/tiddlymap";i.path.localHolders="$:/temp/felixhayashi/tiddlymap/holders";i.path.dialogs="$:/plugins/felixhayashi/tiddlymap/dialog";i.path.footers="$:/plugins/felixhayashi/tiddlymap/dialogFooter";if(!i.ref)i.ref=e.getDataMap();i.ref.defaultGraphViewHolder="$:/plugins/felixhayashi/tiddlymap/misc/defaultViewHolder";i.ref.graphBar="$:/plugins/felixhayashi/tiddlymap/misc/advancedEditorBar";i.ref.sysConf="$:/plugins/felixhayashi/tiddlymap/config/sys";i.ref.sysUserConf="$:/plugins/felixhayashi/tiddlymap/config/sys/user";i.ref.visConf="$:/plugins/felixhayashi/tiddlymap/config/vis";i.ref.visUserConf="$:/plugins/felixhayashi/tiddlymap/config/vis/user";i.ref.welcomeFlag="$:/plugins/felixhayashi/tiddlymap/flag/welcome";i.ref.focusButton="$:/plugins/felixhayashi/tiddlymap/misc/focusButton";i.ref.sysMeta="$:/plugins/felixhayashi/tiddlymap/misc/meta";i.ref.sidebarBreakpoint="$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint";if(!i.config)i.config=e.getDataMap();i.config.sys=e.merge($tw.wiki.getTiddlerData(i.ref.sysConf,{}),e.unflatten($tw.wiki.getTiddlerData(i.ref.sysUserConf,{})));i.config.vis=e.merge($tw.wiki.getTiddlerData(i.ref.visConf,{}),e.unflatten($tw.wiki.getTiddlerData(i.ref.visUserConf,{})));if(!i.field)i.field=e.getDataMap();$tw.utils.extend(i.field,i.config.sys.field);if(!i.misc)i.misc=e.getDataMap();i.misc.unknownEdgeLabel="tmap:undefined";i.misc.cssPrefix="tmap-";i.misc.sysEdgeTypeNS="tmap";i.misc.liveViewLabel="Live View";if(!i.filter)i.filter=e.getDataMap();i.filter.edgeTypes="[prefix["+i.path.edgeTypes+"]]";i.filter.listEdgeTypes="[prefix["+i.path.listEdgeTypes+"]]";i.filter.fieldEdgeTypes="[prefix["+i.path.fieldEdgeTypes+"]]";i.filter.views="[has["+i.field.viewMarker+"]]";i.filter.defaultEdgeFilter=i.filter.edgeTypes+"-[suffix[tw-body:link]]"+"-[suffix[tw-list:tags]]";+"-[suffix[tw-list:list]]";if(!i.selector)i.selector=e.getDataMap();var a="[all[tiddlers+shadows]!has[draft.of]]";i.selector.allEdgeTypes=a+" +"+i.filter.edgeTypes;i.selector.allEdgeTypesByLabel=i.selector.allEdgeTypes+" +[removeprefix["+i.path.edgeTypes+"/]]";i.selector.allViews=a+" +"+i.filter.views;i.selector.allViewsByLabel=i.selector.allViews+"+[removeprefix["+i.path.views+"/]]";i.selector.allPotentialNodes="[all[tiddlers]!is[system]!has[draft.of]]";i.selector.allListEdgeStores=a+" +"+i.filter.listEdgeTypes+" +[removeprefix["+i.path.listEdgeTypes+"]]";i.selector.allFieldEdgeStores=a+" +"+i.filter.fieldEdgeTypes+" +[removeprefix["+i.path.fieldEdgeTypes+"]]"};var l=function(t){$tw.tmap.start("Attaching Indeces");if(!t.indeces){t.indeces={tById:e.getDataMap(),idByT:e.getDataMap()}}var i=$tw.wiki.allTitles();for(var a=0;a<i.length;a++){var s=i[a];var r=$tw.wiki.getTiddler(s);if(!e.isSystemOrDraft(r)){var l=r.fields[$tw.tmap.opt.field.nodeId];if(!l){l=e.genUUID();e.setField(r,$tw.tmap.opt.field.nodeId,l)}t.indeces.tById[l]=s;t.indeces.idByT[s]=l}}$tw.tmap.stop("Attaching Indeces")};var d=function(t){var i=t;var a=function(){};if(e.isTrue($tw.tmap.opt.config.sys.debug,false)&&console){i.logger=function(){if(arguments.length<2)return;var e=Array.prototype.slice.call(arguments);var t=e.shift(e);var i=console.hasOwnProperty(t)?t:"debug";console[i].apply(console,e)};i.start=function(e){console.time("timer: "+e)};i.stop=function(e){console.timeEnd("timer: "+e)}}else{i.logger=a;i.start=a;i.stop=a}i.notify=$tw.tmap.opt.config.sys.notifications==="true"?e.notify:a};var p=function(){for(var e=$tw.tmap.registry.length-1;e>=0;e--){var t=$tw.tmap.registry[e];if(t.isZombieWidget()){$tw.tmap.logger("warn","A graph has been removed.");t.destruct();$tw.tmap.registry.splice(e,1)}}};var f=function(t){var i=$tw.tmap.opt.field.nodeId;var a=t.fields[i];if(!a)return;var s=$tw.tmap.opt;var r=e.getTiddlersWithField(i,a,{limit:2});delete r[t.fields.title];var l=Object.keys(r)[0];if(l){var d={param:{changedTiddler:t.fields.title,existingTiddler:l,idField:i,id:a}};$tw.tmap.dialogManager.open("dublicateIdInfo",d)}if(l){e.setField(t,$tw.tmap.opt.field.edges,undefined);$tw.tmap.adapter.assignId(t,true)}};var n=function(t){if(!t)t=$tw.tmap;if(!t.opt)t.opt=e.getDataMap();r(t.opt);d(t,t.opt);$tw.tmap.logger("warn","Rebuilt globals")};var o=function(t){if(t["$:/HistoryList"]){var i=e.getField("$:/HistoryList","current-tiddler")}else if(t["$:/temp/focussedTiddler"]){var i=e.getField("$:/temp/focussedTiddler","text")}if(i!=null){e.setField("$:/temp/tmap/currentTiddler","text",i)}};var g=function(t){var i="[prefix["+$tw.tmap.opt.path.options+"]!has[draft.of]]";if(e.getMatches(i,Object.keys(t)).length){n()}};var m=function(t){if(e.isTrue($tw.tmap.opt.config.sys.debug,false)){for(var i in t){if(t[i].deleted){$tw.tmap.logger("warn","Tiddler deleted:",i)}else{$tw.tmap.logger("warn","Tiddle modified:",e.getTiddler(i))}}}};var y=function(t){$tw.wiki.addEventListener("change",function(i){$tw.tmap.start("Caretaker handling changes");m(i);t.handleChanges(i);g(i);for(var a in i){if(e.isSystemOrDraft(a))continue;var s=e.getTiddler(a);if(s){f(s);$tw.tmap.adapter.assignId(s)}else{}}o(i);$tw.tmap.stop("Caretaker handling changes")})};var c=function(){if(e.tiddlerExists($tw.tmap.opt.ref.sysMeta))return;$tw.tmap.logger("warn","Creating meta file");var t=$tw.wiki.getTiddler($tw.tmap.opt.path.pluginRoot);$tw.wiki.setTiddlerData($tw.tmap.opt.ref.sysMeta,{originalVersion:t.fields.version,dataStructureState:"0.6.9",showWelcomeMessage:true})};exports.startup=function(){$tw.tmap=e.getDataMap();$tw.tmap.utils=e;$tw.tmap.keycharm=s.keycharm;$tw.tmap.registry=[];window.setInterval(p,1e3);n($tw.tmap);l($tw.tmap);$tw.tmap.adapter=new t;c();$tw.tmap.callbackManager=new a;$tw.tmap.dialogManager=new i($tw.tmap.callbackManager);y($tw.tmap.callbackManager);$tw.tmap.logger("warn","TiddlyMap's caretaker successfully started")}})();