/*\

title: $:/plugins/felixhayashi/tiddlymap/js/caretaker
type: application/javascript
module-type: startup

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var e=require("$:/plugins/felixhayashi/tiddlymap/js/config/vis").config;var t=require("$:/plugins/felixhayashi/tiddlymap/js/config/sys").config;var a=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var i=require("$:/plugins/felixhayashi/tiddlymap/js/Adapter").Adapter;var r=require("$:/plugins/felixhayashi/tiddlymap/js/DialogManager").DialogManager;var s=require("$:/plugins/felixhayashi/tiddlymap/js/CallbackManager").CallbackManager;var l=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction").ViewAbstraction;var d=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var p=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType").NodeType;var o=require("$:/plugins/felixhayashi/vis/vis.js");var n=function(i){var r=i;if(!r.path)r.path=a.getDataMap();r.path.pluginRoot="$:/plugins/felixhayashi/tiddlymap";r.path.edgeTypes="$:/plugins/felixhayashi/tiddlymap/graph/edgeTypes";r.path.nodeTypes="$:/plugins/felixhayashi/tiddlymap/graph/nodeTypes";r.path.listEdgeTypes="$:/plugins/felixhayashi/tiddlymap/graph/edgeTypes/tw-list:";r.path.fieldEdgeTypes="$:/plugins/felixhayashi/tiddlymap/graph/edgeTypes/tw-field:";r.path.views="$:/plugins/felixhayashi/tiddlymap/graph/views";r.path.options="$:/plugins/felixhayashi/tiddlymap/config";r.path.dialogs="$:/plugins/felixhayashi/tiddlymap/dialog";r.path.footers="$:/plugins/felixhayashi/tiddlymap/dialogFooter";r.path.tempRoot="$:/temp/tmap";r.path.localHolders="$:/temp/tmap/holders";if(!r.ref)r.ref=a.getDataMap();r.ref.defaultViewHolder="$:/plugins/felixhayashi/tiddlymap/misc/defaultViewHolder";r.ref.graphBar="$:/plugins/felixhayashi/tiddlymap/misc/advancedEditorBar";r.ref.sysUserConf="$:/plugins/felixhayashi/tiddlymap/config/sys/user";r.ref.visUserConf="$:/plugins/felixhayashi/tiddlymap/config/vis/user";r.ref.welcomeFlag="$:/plugins/felixhayashi/tiddlymap/flag/welcome";r.ref.focusButton="$:/plugins/felixhayashi/tiddlymap/misc/focusButton";r.ref.sysMeta="$:/plugins/felixhayashi/tiddlymap/misc/meta";r.ref.sidebarBreakpoint="$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint";if(!r.config)r.config=a.getDataMap();r.config.sys=a.merge({},t,a.unflatten($tw.wiki.getTiddlerData(r.ref.sysUserConf)));r.config.vis=a.merge({},e,$tw.wiki.getTiddlerData(r.ref.visUserConf));if(!r.field)r.field=a.getDataMap();$tw.utils.extend(r.field,r.config.sys.field);if(!r.misc)r.misc=a.getDataMap();r.misc.unknownEdgeLabel="tmap:undefined";r.misc.liveViewLabel="Live View";r.misc.defaultViewLabel="Default";if(!r.filter)r.filter=a.getDataMap();r.filter.nodeTypes="[prefix["+r.path.nodeTypes+"]]";r.filter.edgeTypes="[prefix["+r.path.edgeTypes+"]]";r.filter.listEdgeTypes="[prefix["+r.path.listEdgeTypes+"]]";r.filter.fieldEdgeTypes="[prefix["+r.path.fieldEdgeTypes+"]]";r.filter.views="["+r.field.viewMarker+"[true]]";r.filter.defaultEdgeFilter=r.filter.edgeTypes+"-[suffix[tw-body:link]]"+"-[suffix[tw-list:tags]]";+"-[suffix[tw-list:list]]";if(!r.selector)r.selector=a.getDataMap();var s="[all[tiddlers+shadows]!has[draft.of]]";r.selector.allEdgeTypes=s+" +"+r.filter.edgeTypes;r.selector.allEdgeTypesByLabel=r.selector.allEdgeTypes+" +[removeprefix["+r.path.edgeTypes+"/]]";r.selector.allNodeTypes=s+" +"+r.filter.nodeTypes;r.selector.allNodeTypesByLabel=r.selector.allNodeTypes+" +[removeprefix["+r.path.nodeTypes+"/]]";r.selector.allViews=s+" +"+r.filter.views;r.selector.allViewsByLabel=r.selector.allViews+"+[removeprefix["+r.path.views+"/]]";r.selector.allPotentialNodes="[all[tiddlers]!is[system]!has[draft.of]]";r.selector.allListEdgeStores=s+" +"+r.filter.listEdgeTypes+" +[removeprefix["+r.path.listEdgeTypes+"]]";r.selector.allFieldEdgeStores=s+" +"+r.filter.fieldEdgeTypes+" +[removeprefix["+r.path.fieldEdgeTypes+"]]"};var f=function(e){$tw.tmap.start("Attaching Indeces");e.indeces=e.indeces||{};var t=$tw.wiki.allTitles();g(e.indeces,t);y(e.indeces,t);$tw.tmap.stop("Attaching Indeces")};var g=function(e,t){e=e||$tw.tmap.indeces;t=t||$tw.wiki.allTitles();var i=$tw.tmap.opt.field.nodeId;var r=e.tById={};var s=e.idByT={};for(var l=t.length;l--;){var d=t[l];var p=$tw.wiki.getTiddler(d);if(a.isSystemOrDraft(p))continue;var o=p.fields[i];if(!o){o=a.genUUID();a.setField(p,i,o)}r[o]=d;s[d]=o}};var y=function(e,t){e=e||$tw.tmap.indeces;t=t||$tw.wiki.allTitles();var i=$tw.tmap.opt.path.nodeTypes;var r=e.glNTy=[];var s=e.loNTy=[];for(var l=t.length;l--;){if(a.startsWith(t[l],i)){var d=new p(t[l]);(d.data.view?s:r).push(d)}}e.glLoNTy=r.concat(s);e.loGlNTy=s.concat(r)};var m=function(e){var t=e;var i=function(){};if(a.isTrue($tw.tmap.opt.config.sys.debug,false)&&console){t.logger=function(){if(arguments.length<2)return;var e=Array.prototype.slice.call(arguments);var t=e.shift(e);var a=console.hasOwnProperty(t)?t:"debug";console[a].apply(console,e)};t.start=function(e){console.time("timer: "+e)};t.stop=function(e){console.timeEnd("timer: "+e)}}else{t.logger=t.start=t.stop=i}t.notify=a.isTrue($tw.tmap.opt.config.sys.notifications)?a.notify:i};var c=function(){for(var e=$tw.tmap.registry.length;e--;){var t=$tw.tmap.registry[e];if(t.isZombieWidget()){$tw.tmap.logger("warn","A graph has been removed.");t.destruct();$tw.tmap.registry.splice(e,1)}}};var w=function(e){var t=$tw.tmap.opt.field.nodeId;var i=e.fields[t];if(!i)return;var r=$tw.tmap.opt;var s=a.getTiddlersWithField(t,i,{limit:2});delete s[e.fields.title];var l=Object.keys(s)[0];if(l){var d={param:{changedTiddler:e.fields.title,existingTiddler:l,idField:t,id:i}};$tw.tmap.dialogManager.open("dublicateIdInfo",d)}if(l){a.setField(e,"tmap.edges",undefined);$tw.tmap.adapter.assignId(e,true)}};var u=function(e){if(!e)e=$tw.tmap;if(!e.opt)e.opt=a.getDataMap();n(e.opt);m(e,e.opt);$tw.tmap.logger("warn","Rebuilt globals")};var h=function(e){if(e["$:/HistoryList"]){var t=a.getField("$:/HistoryList","current-tiddler")}else if(e["$:/temp/focussedTiddler"]){var t=a.getField("$:/temp/focussedTiddler","text")}if(t!=null){a.setField("$:/temp/tmap/currentTiddler","text",t)}};var $=function(e){if(a.isTrue($tw.tmap.opt.config.sys.debug,false)){for(var t in e){if(e[t].deleted){$tw.tmap.logger("warn","Tiddler deleted:",t)}else{$tw.tmap.logger("warn","Tiddler modified:",t,a.getTiddler(t))}}}};var v=function(e){var t=$tw.tmap.opt.path.nodeTypes;var i=$tw.tmap.opt.path.options;var r=$tw.tmap.opt.field.nodeId;var s=0;$tw.wiki.addEventListener("change",function(l){$tw.tmap.start("Caretaker handling changes");$tw.tmap.logger("warn","=== Refresh "+s++ +" ===");$(l);e.handleChanges(l);var d=false;var p=false;for(var o in l){if(a.isSystemOrDraft(o)){if(a.startsWith(o,t)&&!d){y();d=true}if(a.startsWith(o,i)&&!p){u();p=true}continue}var n=a.getTiddler(o);if(n){w(n);$tw.tmap.adapter.assignId(n)}else{var f=$tw.tmap.indeces.idByT[o];if(!f){$tw.tmap.logger("warn","Ignoring Tiddler",o,"without id; Assuming draft");continue}var g=a.getTiddlerWithField(r,f);if(g){$tw.tmap.logger("warn","Tiddler",o,"renamed into",g)}else{$tw.tmap.logger("warn","Tiddler",o,"removed");$tw.tmap.adapter.deleteNode(f)}}}h(l);$tw.tmap.stop("Caretaker handling changes")})};var T=function(){var e=$tw.tmap.opt.config.sys.defaultView;if(e){a.setField($tw.tmap.opt.ref.defaultViewHolder,"text",e)}};var x=function(){if(a.tiddlerExists($tw.tmap.opt.ref.sysMeta))return;$tw.tmap.logger("warn","Creating meta file");var e=$tw.wiki.getTiddler($tw.tmap.opt.path.pluginRoot);$tw.wiki.setTiddlerData($tw.tmap.opt.ref.sysMeta,{originalVersion:e.fields.version,dataStructureState:"0.6.9",showWelcomeMessage:true})};exports.name="tmap.caretaker";exports.platforms=["browser"];exports.after=["startup"];exports.before=["rootwidget"];exports.synchronous=true;exports.startup=function(){$tw.tmap=a.getDataMap();$tw.tmap.utils=a;$tw.tmap.keycharm=o.keycharm;$tw.tmap.obj={NodeType:p,EdgeType:d,ViewAbstraction:l};$tw.tmap.registry=[];window.setInterval(c,5e3);u($tw.tmap);f($tw.tmap);T();$tw.tmap.adapter=new i;x();$tw.tmap.callbackManager=new s;$tw.tmap.dialogManager=new r($tw.tmap.callbackManager);v($tw.tmap.callbackManager);$tw.tmap.logger("warn","TiddlyMap's caretaker successfully started")}})();