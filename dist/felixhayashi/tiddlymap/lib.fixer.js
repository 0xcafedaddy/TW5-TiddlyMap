/*\

title: $:/plugins/felixhayashi/tiddlymap/js/fixer
type: application/javascript
module-type: library

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var t=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var e=require("$:/plugins/felixhayashi/tiddlymap/js/Adapter").Adapter;var r=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction").ViewAbstraction;var a=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var i=function(e,r){var i=t.getByPrefix(e);for(var s=0;s<i.length;s++){var d=t.getBasename(i[s]);if(d==="__noname__"){d="tmap:unknown"}d=new a(d);if(!d.exists())d.save();var f=$tw.wiki.getTiddlerData(i[s]);for(var u=0;u<f.length;u++){f[u].type=(r?r+":":"")+d.id;$tw.tmap.adapter.insertEdge(f[u])}$tw.wiki.deleteTiddler(i[s])}};var s={};s.fixId=function(){var e=$tw.wiki.getTiddlerData($tw.tmap.opt.ref.sysMeta,{});var r={before:"0.9.0",after:"0.9.2"};if(t.isLeftVersionGreater(r.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",r.after);if(t.isLeftVersionGreater("0.9.2",e.originalVersion)){var a="$:/plugins/felixhayashi/tiddlymap/config/sys/user";var i=t.getEntry(a,"field.nodeId","tmap.id");t.moveFieldValues(i,"tmap.id",true,false)}t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",r.after)}};s.fix=function(){var e=$tw.wiki.getTiddlerData($tw.tmap.opt.ref.sysMeta,{});$tw.tmap.logger("debug","Fixer is started");$tw.tmap.logger("debug","Data-structure currently in use: ",e.dataStructureState);var a={before:"0.6.11",after:"0.7.0"};if(t.isLeftVersionGreater(a.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",a.after);i("$:/plugins/felixhayashi/tiddlymap/graph/edges",null);var d=$tw.tmap.opt.selector.allViews;var f=t.getMatches(d);for(var u=0;u<f.length;u++){var g=new r(f[u]);i(g.getRoot()+"/graph/edges",g)}t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",a.after)}var a={before:"0.7.31",after:"0.7.32"};if(t.isLeftVersionGreater(a.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",a.after);var p=$tw.tmap.adapter.getView("Live View");p.setNodeFilter("[field:title{$:/temp/tmap/currentTiddler}]",true);p.setConfig({"refresh-trigger":null,"refresh-triggers":$tw.utils.stringifyList(["$:/temp/tmap/currentTiddler"])});t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",a.after)}var a={before:"0.7.32",after:"0.9.0"};if(t.isLeftVersionGreater(a.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",a.after);var o=$tw.tmap.opt.ref.visUserConf;var n=t.unflatten($tw.wiki.getTiddlerData(o,{}));if(typeof n.groups==="object"){var l=new $tw.tmap.NodeType("tmap:neighbour");l.setStyle(n.groups["neighbours"]);l.save();delete n.groups;$tw.wiki.setTiddlerData(o,n)}t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",a.after)}s.fixId()};exports.fixer=s})();