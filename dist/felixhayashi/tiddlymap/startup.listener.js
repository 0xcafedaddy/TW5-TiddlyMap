/*\

title: $:/plugins/felixhayashi/tiddlymap/js/startup/listener
type: application/javascript
module-type: startup

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var e=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType").NodeType;var t=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var a=function(){this.adapter=$tw.tmap.adapter;this.wiki=$tw.wiki;this.logger=$tw.tmap.logger;this.opt=$tw.tmap.opt;this.utils=$tw.tmap.utils;this.dialogManager=$tw.tmap.dialogManager;this.utils.addListeners({"tmap:tm-remove-edge":this.handleRemoveEdge,"tmap:tm-load-type-form":this.handleLoadTypeForm,"tmap:tm-save-type-form":this.handleSaveTypeForm,"tmap:tm-create-type":this.handleCreateType,"tmap:tm-create-edge":this.handleCreateEdge,"tmap:tm-suppress-dialog":this.handleSuppressDialog,"tmap:tm-generate-widget":this.handleGenerateWidget,"tmap:tm-download-graph":this.handleDownloadGraph,"tmap:tm-manage-edge-types":this.handleOpenTypeManager,"tmap:tm-manage-node-types":this.handleOpenTypeManager,"tmap:tm-cancel-dialog":this.handleCancelDialog,"tmap:tm-confirm-dialog":this.handleConfirmDialog},$tw.rootWidget,this)};a.prototype.handleCancelDialog=function(e){this.utils.setField(e.param,"text","")};a.prototype.handleConfirmDialog=function(e){this.utils.setField(e.param,"text","1")};a.prototype.handleSuppressDialog=function(e){if(this.utils.isTrue(e.paramObject.suppress,false)){this.utils.setEntry(this.opt.ref.sysUserConf,"suppressedDialogs."+e.paramObject.dialog,true)}};a.prototype.handleDownloadGraph=function(e){var t=this.adapter.getGraph({view:e.paramObject.view});t.nodes=this.utils.convert(t.nodes,"array");t.edges=this.utils.convert(t.edges,"array");var a="$:/temp/tmap/export";this.utils.setField(a,"text",JSON.stringify(t,null,2));$tw.rootWidget.dispatchEvent({type:"tm-download-file",param:a,paramObject:{filename:e.paramObject.view+".json"}})};a.prototype.handleGenerateWidget=function(e){if(!e.paramObject)e.paramObject={};var t={dialog:{preselects:{view:e.paramObject.view||this.opt.misc.defaultViewLabel}}};this.dialogManager.open("getWidgetCode",t)};a.prototype.handleRemoveEdge=function(e){this.adapter.deleteEdge(e.paramObject)};a.prototype.handleCreateEdge=function(e){var t={from:this.adapter.makeNode(e.paramObject.from).id,to:this.adapter.makeNode(e.paramObject.to).id,type:e.paramObject.label,id:e.paramObject.id};this.adapter.insertEdge(t);$tw.tmap.notify("Edge inserted")};a.prototype.handleOpenTypeManager=function(e){if(!e.paramObject)e.paramObject={};var t=e.type.match(/tmap:tm-(.*)/)[1];if(t==="manage-edge-types"){var a="Edge-Type Manager";var i=this.opt.selector.allEdgeTypesByLabel}else{var a="Node-Type Manager";var i=this.opt.selector.allNodeTypesByLabel}var p={mode:t,topic:a,filter:i+" +[search:title{$:/temp/tmap/elementTypeSearch}]"+" +[sort[title]]"};var r=this.dialogManager.open("elementTypeManager",p);if(e.paramObject.type){this.handleLoadTypeForm({paramObject:{mode:t,id:e.paramObject.type,output:r.fields["output"]}})}};a.prototype.handleLoadTypeForm=function(a){var i=a.paramObject.output;var p=a.paramObject.mode==="manage-edge-types"?new t(a.paramObject.id):new e(a.paramObject.id);p.persist(i,true);if(a.paramObject.mode==="manage-edge-types"){var r=this.adapter.selectEdgesByType(p);var d=Object.keys(r).length;this.utils.setField(i,"temp.usageCount",d)}$tw.wiki.addTiddler(new $tw.Tiddler(this.utils.getTiddler(i),{"temp.idImmutable":p.isShipped()?"true":"","temp.newId":p.getId(),"vis-inherited":JSON.stringify(this.opt.config.vis)}));this.utils.deleteByPrefix("$:/state/tabs/elementTypeManager")};a.prototype.handleSaveTypeForm=function(a){var i=this.utils.getTiddler(a.paramObject.output);if(!i)return;var p=a.paramObject.mode;var r=p==="manage-edge-types"?new t(i.fields.id):new e(i.fields.id);if(this.utils.isTrue(i.fields["temp.deleteType"],false)){this.deleteType(p,r,i)}else{this.saveType(p,r,i)}};a.prototype.deleteType=function(e,t,a){this.logger("debug","Deleting type",t);if(e==="manage-edge-types"){this.adapter._processEdgesWithType(t,{action:"delete"})}else{this.adapter.removeNodeType(t)}this.wiki.addTiddler(new $tw.Tiddler({title:this.utils.getTiddlerRef(a)}));$tw.tmap.notify("Deleted type")};a.prototype.saveType=function(e,t,a){var i=this.utils.getTiddler(a);t.loadDataFromTiddler(i);t.persist();if(!i.fields["temp.newId"]){this.utils.setField(i,"temp.newId",i.fields["id"])}else if(i.fields["temp.newId"]!==i.fields["id"]){if(e==="manage-edge-types"){this.adapter._processEdgesWithType(t,{action:"rename",newName:i.fields["temp.newId"]})}this.utils.setField(i,"id",i.fields["temp.newId"])}$tw.tmap.notify("Saved type data")};a.prototype.handleCreateType=function(e){var t=e.paramObject.id;var a=e.paramObject.mode==="manage-edge-types"?"edge":"node";this.handleLoadTypeForm({paramObject:{id:this.adapter.createType(a,t).getId(),mode:e.paramObject.mode,output:e.paramObject.output}})};a.prototype.getTypeFromEvent=function(a){return a.paramObject.mode==="manage-edge-types"?new t(a.paramObject.id):new e(a.paramObject.id)};exports.name="tmap.listener";exports.platforms=["browser"];exports.after=["rootwidget","tmap.caretaker"];exports.before=["story"];exports.synchronous=true;exports.startup=function(){new a}})();