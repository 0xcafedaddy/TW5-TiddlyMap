/*\

title: $:/plugins/felixhayashi/tiddlymap/js/startup/listener
type: application/javascript
module-type: startup

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var e=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType").NodeType;var t=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var a=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var p=function(){this.adapter=$tw.tmap.adapter;this.wiki=$tw.wiki;this.logger=$tw.tmap.logger;this.opt=$tw.tmap.opt;this.dialogManager=$tw.tmap.dialogManager;a.addListeners({"tmap:tm-remove-edge":this.handleRemoveEdge,"tmap:tm-load-type-form":this.handleLoadTypeForm,"tmap:tm-save-type-form":this.handleSaveTypeForm,"tmap:tm-create-type":this.handleCreateType,"tmap:tm-create-edge":this.handleCreateEdge,"tmap:tm-suppress-dialog":this.handleSuppressDialog,"tmap:tm-generate-widget":this.handleGenerateWidget,"tmap:tm-download-graph":this.handleDownloadGraph,"tmap:tm-manage-edge-types":this.handleOpenTypeManager,"tmap:tm-manage-node-types":this.handleOpenTypeManager,"tmap:tm-cancel-dialog":this.handleCancelDialog,"tmap:tm-confirm-dialog":this.handleConfirmDialog},$tw.rootWidget,this)};p.prototype.handleCancelDialog=function(e){a.setField(e.param,"text","")};p.prototype.handleConfirmDialog=function(e){a.setField(e.param,"text","1")};p.prototype.handleSuppressDialog=function(e){if(a.isTrue(e.paramObject.suppress,false)){a.setEntry(this.opt.ref.sysUserConf,"suppressedDialogs."+e.paramObject.dialog,true)}};p.prototype.handleDownloadGraph=function(e){var t=this.adapter.getGraph({view:e.paramObject.view});t.nodes=a.convert(t.nodes,"array");t.edges=a.convert(t.edges,"array");var p="$:/temp/tmap/export";a.setField(p,"text",JSON.stringify(t,null,2));$tw.rootWidget.dispatchEvent({type:"tm-download-file",param:p,paramObject:{filename:e.paramObject.view+".json"}})};p.prototype.handleGenerateWidget=function(e){if(!e.paramObject)e.paramObject={};var t={dialog:{preselects:{view:e.paramObject.view||this.opt.misc.defaultViewLabel}}};this.dialogManager.open("getWidgetCode",t)};p.prototype.handleRemoveEdge=function(e){this.adapter.deleteEdge(e.paramObject)};p.prototype.handleCreateEdge=function(e){var t=e.paramObject.from;var p=e.paramObject.to;var r=e.paramObject.force;if(!t||!p)return;if(a.tiddlerExists(t)&&a.tiddlerExists(p)||r){a.addTiddler(p);a.addTiddler(t);var i={from:this.adapter.makeNode(t).id,to:this.adapter.makeNode(p).id,type:e.paramObject.label,id:e.paramObject.id};this.adapter.insertEdge(i);$tw.tmap.notify("Edge inserted")}};p.prototype.handleOpenTypeManager=function(e){if(!e.paramObject)e.paramObject={};var t=e.type.match(/tmap:tm-(.*)/)[1];if(t==="manage-edge-types"){var a="Edge-Type Manager";var p=this.opt.selector.allEdgeTypes;var r=this.opt.path.edgeTypes}else{var a="Node-Type Manager";var p=this.opt.selector.allNodeTypes;var r=this.opt.path.nodeTypes}var i={mode:t,topic:a,searchSelector:p,typeRootPath:r};var d=this.dialogManager.open("MapElementTypeManager",i);if(e.paramObject.type){this.handleLoadTypeForm({paramObject:{mode:t,id:e.paramObject.type,output:d.fields["output"]}})}};p.prototype.handleLoadTypeForm=function(p){var r=p.paramObject.output;var i=p.paramObject.mode==="manage-edge-types"?new t(p.paramObject.id):new e(p.paramObject.id);i.save(r);if(p.paramObject.mode==="manage-edge-types"){var d=this.adapter.selectEdgesByType(i);var o=Object.keys(d).length;a.setField(r,"temp.usageCount",o)}$tw.wiki.addTiddler(new $tw.Tiddler(a.getTiddler(r),{"temp.idImmutable":i.isShipped?"true":"","temp.newId":i.id,"vis-inherited":JSON.stringify(this.opt.config.vis)}));a.deleteByPrefix("$:/state/tabs/MapElementTypeManager")};p.prototype.handleSaveTypeForm=function(p){var r=a.getTiddler(p.paramObject.output);if(!r)return;var i=p.paramObject.mode;var d=i==="manage-edge-types"?new t(r.fields.id):new e(r.fields.id);if(a.isTrue(r.fields["temp.deleteType"],false)){this.deleteType(i,d,r)}else{this.saveType(i,d,r)}};p.prototype.deleteType=function(e,t,p){this.logger("debug","Deleting type",t);if(e==="manage-edge-types"){this.adapter._processEdgesWithType(t,{action:"delete"})}else{this.adapter.removeNodeType(t)}this.wiki.addTiddler(new $tw.Tiddler({title:a.getTiddlerRef(p)}));$tw.tmap.notify("Deleted type")};p.prototype.saveType=function(t,p,r){var i=a.getTiddler(r);p.loadFromTiddler(i);if(p instanceof e){}p.save();if(!i.fields["temp.newId"]){a.setField(i,"temp.newId",i.fields["id"])}else if(i.fields["temp.newId"]!==i.fields["id"]){if(t==="manage-edge-types"){this.adapter._processEdgesWithType(p,{action:"rename",newName:i.fields["temp.newId"]})}a.setField(i,"id",i.fields["temp.newId"])}$tw.tmap.notify("Saved type data")};p.prototype.handleCreateType=function(a){var p=a.paramObject.id||"New type";var r=a.paramObject.mode==="manage-edge-types"?new t(p):new e(p);r.save();this.handleLoadTypeForm({paramObject:{id:r.id,mode:a.paramObject.mode,output:a.paramObject.output}})};p.prototype.getTypeFromEvent=function(a){return a.paramObject.mode==="manage-edge-types"?new t(a.paramObject.id):new e(a.paramObject.id)};exports.name="tmap.listener";exports.platforms=["browser"];exports.after=["rootwidget","tmap.caretaker"];exports.before=["story"];exports.synchronous=true;exports.startup=function(){new p}})();