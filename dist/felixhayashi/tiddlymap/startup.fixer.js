/*\

title: $:/plugins/felixhayashi/tiddlymap/js/fixer
type: application/javascript
module-type: startup

@module TiddlyMap
@preserve

\*/
(function(){"use strict";exports.name="tmap.fixer";exports.after=["tmap.caretaker"];exports.before=["rootwidget"];exports.synchronous=true;var t=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var e=require("$:/plugins/felixhayashi/tiddlymap/js/Adapter").Adapter;var r=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction").ViewAbstraction;var a=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var i=function(e,r){var i=t.getByPrefix(e);for(var s=0;s<i.length;s++){var p=t.getBasename(i[s]);if(p==="__noname__"){p="tmap:unknown"}p=new a(p);if(!p.exists())p.persist();var u=$tw.wiki.getTiddlerData(i[s]);for(var d=0;d<u.length;d++){u[d].type=(r?r+":":"")+p.getId();$tw.tmap.adapter.insertEdge(u[d])}$tw.wiki.deleteTiddler(i[s])}};exports.startup=function(){var e=$tw.wiki.getTiddlerData($tw.tmap.opt.ref.sysMeta,{});var a=$tw.wiki.getTiddler($tw.tmap.opt.path.pluginRoot);$tw.tmap.logger("debug","Fixer is started");$tw.tmap.logger("debug","Data-structure currently in use: ",e.dataStructureState);var s={before:"0.6.11",after:"0.7.0"};if($tw.utils.checkVersions(s.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",s.after);i("$:/plugins/felixhayashi/tiddlymap/graph/edges",null);var p=$tw.tmap.opt.selector.allViews;var u=t.getMatches(p);for(var d=0;d<u.length;d++){var o=new r(u[d]);i(o.getRoot()+"/graph/edges",o)}t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",s.after)}var s={before:"0.7.31",after:"0.7.32"};if($tw.utils.checkVersions(s.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",s.after);var g=$tw.tmap.adapter.getView("Live View");g.setNodeFilter("[field:title{$:/temp/tmap/currentTiddler}]",true);g.setConfig({"refresh-trigger":null,"refresh-triggers":$tw.utils.stringifyList(["$:/temp/tmap/currentTiddler"])});t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",s.after)}var s={before:"0.7.32",after:"0.9.0"};if($tw.utils.checkVersions(s.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",s.after);var l=$tw.tmap.opt.ref.visUserConf;var n=t.unflatten($tw.wiki.getTiddlerData(l,{}));if(typeof n.groups==="object"){new $tw.tmap.obj.NodeType("tmap:neighbour").setStyle(n.groups["neighbours"]).persist();delete n.groups;$tw.wiki.setTiddlerData(l,n)}t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",s.after)}}})();