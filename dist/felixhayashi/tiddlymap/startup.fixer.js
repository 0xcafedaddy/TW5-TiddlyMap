/*\

title: $:/plugins/felixhayashi/tiddlymap/fixer.js
type: application/javascript
module-type: startup

@module TiddlyMap
@preserve

\*/
(function(){"use strict";exports.name="tmap.fixer";exports.after=["tmap.caretaker"];exports.before=["rootwidget"];exports.synchronous=true;var t=require("$:/plugins/felixhayashi/tiddlymap/utils.js").utils;var e=require("$:/plugins/felixhayashi/tiddlymap/adapter.js").Adapter;var r=require("$:/plugins/felixhayashi/tiddlymap/view_abstraction.js").ViewAbstraction;var a=require("$:/plugins/felixhayashi/tiddlymap/edgetype.js").EdgeType;var i=function(e,r){var i=t.getByPrefix(e);for(var s=0;s<i.length;s++){var p=t.getBasename(i[s]);if(p==="__noname__"){p="tmap:unknown"}p=new a(p);if(!p.exists())p.persist();var d=$tw.wiki.getTiddlerData(i[s]);for(var u=0;u<d.length;u++){d[u].type=(r?r+":":"")+p.getId();$tw.tmap.adapter.insertEdge(d[u])}$tw.wiki.deleteTiddler(i[s])}};exports.startup=function(){var e=$tw.wiki.getTiddlerData($tw.tmap.opt.ref.sysMeta,{});var a=$tw.wiki.getTiddler($tw.tmap.opt.path.pluginRoot);$tw.tmap.logger("debug","Fixer is started");$tw.tmap.logger("debug","Data-structure currently in use: ",e.dataStructureState);var s={before:"0.6.11",after:"0.7.0"};if($tw.utils.checkVersions(s.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",s.after);i("$:/plugins/felixhayashi/tiddlymap/graph/edges",null);var p=$tw.tmap.opt.selector.allViews;var d=t.getMatches(p);for(var u=0;u<d.length;u++){var g=new r(d[u]);i(g.getRoot()+"/graph/edges",g)}t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",s.after)}var s={before:"0.7.31",after:"0.7.32"};if($tw.utils.checkVersions(s.before,e.dataStructureState)){$tw.tmap.logger("debug","Upgrading data structure to",s.after);var l=$tw.tmap.adapter.getView("Live View");l.setNodeFilter("[field:title{$:/temp/tmap/currentTiddler}]",true);l.setConfig({"refresh-trigger":null,"refresh-triggers":$tw.utils.stringifyList(["$:/temp/tmap/currentTiddler"])});t.setEntry($tw.tmap.opt.ref.sysMeta,"dataStructureState",s.after)}}})();