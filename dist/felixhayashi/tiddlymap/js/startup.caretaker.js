/*\

title: $:/plugins/felixhayashi/tiddlymap/js/startup/caretaker
type: application/javascript
module-type: startup

@preserve

\*/
"use strict";exports.name="tmap.caretaker";exports.platforms=["browser"];exports.after=["startup","tmap.environment"];exports.before=["rootwidget"];exports.synchronous=true;exports.startup=startup;var visConfig=require("$:/plugins/felixhayashi/tiddlymap/js/config/vis");var utils=require("$:/plugins/felixhayashi/tiddlymap/js/utils");var fixer=require("$:/plugins/felixhayashi/tiddlymap/js/fixer");var Adapter=require("$:/plugins/felixhayashi/tiddlymap/js/Adapter");var DialogManager=require("$:/plugins/felixhayashi/tiddlymap/js/DialogManager");var CallbackManager=require("$:/plugins/felixhayashi/tiddlymap/js/CallbackManager");var ViewAbstraction=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction");var EdgeType=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType");var NodeType=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType");var vis=require("$:/plugins/felixhayashi/vis/vis.js");function startup(){$tm.utils=utils;$tm.keycharm=vis.keycharm;$tm.NodeType=NodeType;$tm.EdgeType=EdgeType;$tm.ViewAbstraction=ViewAbstraction;$tm.url=new $tm.utils.URL(window.location.href);updateGlobals();createMetaFile();cleanup();attachIndeces($tm);$tm.updateTree=updateTree;setDefaults();$tm.adapter=new Adapter;fixer.fix();$tm.callbackManager=new CallbackManager;$tm.dialogManager=new DialogManager($tm.callbackManager);$tm.registry=[];window.setInterval(routineCheck,5e3);registerChangeListener($tm.callbackManager);registerMousemoveListener();registerClickListener();maybePrepareForFullscreenStart($tm.url);$tm.logger("warn","TiddlyMap's caretaker successfully started")}var attachOptions=function(e){var t=e;if(!t.config)t.config=utils.makeHashMap();t.config.sys=utils.merge(t.config.sys,utils.unflatten($tw.wiki.getTiddlerData(t.ref.sysUserConf)));t.config.vis=utils.merge({},visConfig,utils.parseFieldData(t.ref.visUserConf));if(!t.field)t.field=utils.makeHashMap();$tw.utils.extend(t.field,t.config.sys.field)};var attachIndeces=function(e){$tm.start("Attaching Indeces");if(!e.indeces){e.indeces={};var t=$tm.path.pluginRoot;e.indeces.tmapTiddlers=$tw.wiki.getPluginInfo(t).tiddlers}var i=$tw.wiki.allTitles();updateTiddlerVsIdIndeces(e.indeces,i);updateNodeTypesIndeces(e.indeces);updateEdgeTypesIndeces(e.indeces);$tm.stop("Attaching Indeces")};var updateTiddlerVsIdIndeces=function(e,t){e=e||$tm.indeces;t=t||$tw.wiki.allTitles();fixer.fixId();var i=e.tById={};var a=e.idByT={};$tw.wiki.each(function(e,t){if(utils.isSystemOrDraft(e))return;var r=e.fields["tmap.id"];if(!r){r=utils.genUUID();utils.setField(e,"tmap.id",r)}i[r]=t;a[t]=r})};var updateNodeTypesIndeces=function(e){e=e||$tm.indeces;var t=$tm.path.nodeTypes;var i=e.glNTy=[];var a=e.glNTyById=utils.makeHashMap();$tw.wiki.eachTiddlerPlusShadows(function(e,r){if(utils.startsWith(r,t)){var s=new NodeType(r);a[s.id]=s;i.push(s)}});i.sort(function(e,t){return e.priority-t.priority})};var updateEdgeTypesIndeces=function(e){e=e||$tm.indeces;var t=$tm.path.edgeTypes;var i=e.allETy=utils.makeHashMap();var a=e.maETyFiNa=utils.makeHashMap();var r=utils.getLookupTable($tm.misc.magicETyNamespaces);$tw.wiki.eachTiddlerPlusShadows(function(e,s){if(utils.startsWith(s,t)){var n=new EdgeType(s);i[n.id]=n;if(r[n.namespace]){a[n.name]=n}}})};var updateAdjacencyList=function(e){};var attachFunctions=function(e){var t=e;var i=function(){};if(utils.isTrue($tm.config.sys.debug,false)&&console){t.logger=function(){if(arguments.length<2)return;var e=Array.prototype.slice.call(arguments);var t=e.shift(e);var i=console.hasOwnProperty(t)?t:"debug";console[i].apply(console,e)};t.start=function(e){console.time("[timer] "+e)};t.stop=function(e){console.timeEnd("[timer] "+e)}}else{t.logger=t.start=t.stop=i}t.notify=utils.isTrue($tm.config.sys.notifications)?utils.notify:i};var routineCheck=function(){for(var e=$tm.registry.length;e--;){var t=$tm.registry[e];if(!t.destruct||!t.isZombieWidget)return;if(t.isZombieWidget()){$tm.logger("warn","a widget will be removed");$tm.registry.splice(e,1);t.destruct()}}};var dispatchUpdates=function(e){var t=$tm.registry;for(var i=t.length;i--;){var a=t[i];if(!a.destruct||!a.isZombieWidget)return;if(a.update&&!a.isZombieWidget()){a.update(e)}}};var checkForDublicates=function(e){var t=e.fields["tmap.id"];if(!t)return;var i=$tm;var a=utils.getTiddlersWithField("tmap.id",t,{limit:2});delete a[e.fields.title];var r=Object.keys(a)[0];if(r){var s={param:{changedTiddler:e.fields.title,existingTiddler:r,id:t}};$tm.dialogManager.open("dublicateIdInfo",s)}if(r){utils.setField(e,"tmap.edges",undefined);$tm.adapter.assignId(e,true)}};var updateGlobals=function(e){attachOptions($tm);attachFunctions($tm);$tm.logger("warn","Rebuilt globals")};var lastCurrentTiddler=null;var updateLiveViewTrigger=function(e){if(e["$:/HistoryList"]){var t=utils.getField("$:/HistoryList","current-tiddler")}else if(e["$:/temp/focussedTiddler"]){var t=utils.getField("$:/temp/focussedTiddler","text")}if(t!=null&&lastCurrentTiddler!==t){lastCurrentTiddler=t;utils.setField("$:/temp/tmap/currentTiddler","text",t)}};var printChanges=function(e,t){if(!utils.isTrue($tm.config.sys.debug,false))return;$tm.logger("warn","=== Refresh "+t+" ===");for(var i in e){var a=e[i].deleted?"[Deleted]":"[Modified]";$tm.logger("warn",a,i,$tw.wiki.getTiddler(i))}};var registerMousemoveListener=function(){$tm.mouse={};var e=function(e){$tm.mouse=e};window.addEventListener("mousemove",e,false)};var registerClickListener=function(){var e=$tm.path.tempPopups;window.addEventListener("click",function(t){var i=utils.getTiddlersByPrefix(e);for(var a=i.length;a--;){if(utils.getText(i[a]))break}if(a===-1)return;if(!$tw.utils.hasClass(t.target,"tc-drop-down")&&!utils.getAncestorWithClass(t.target,"tc-drop-down")){for(var a=i.length;a--;){utils.setText(i[a],"")}}},false)};var updateTree=function(){updateGlobals();updateNodeTypesIndeces();updateEdgeTypesIndeces()};var registerChangeListener=function(e){var t=0;var i={};i[$tm.path.options]=updateGlobals;i[$tm.path.nodeTypes]=updateNodeTypesIndeces;i[$tm.path.edgeTypes]=updateEdgeTypesIndeces;$tw.wiki.addEventListener("change",function(a){$tm.start("Caretaker handling changes");printChanges(a,t++);e.handleChanges(a);var r={changedTiddlers:a};for(var s in a){var n=utils.getTiddler(s);if(n&&n.isDraft())continue;if($tw.wiki.isSystemTiddler(s)){handleSysTidChanges(s,n,r,i)}else{handleTidChanges(s,n,r)}}dispatchUpdates(r);updateLiveViewTrigger(a);$tm.stop("Caretaker handling changes")})};var handleSysTidChanges=function(e,t,i,a){var r=$tm.path;for(var s in a){if(utils.startsWith(e,s)&&!i[s]){$tm.logger("warn","[System change]",s);a[s]();i[s]=true;return}}};var handleTidChanges=function(e,t,i){if(t){checkForDublicates(t);$tm.adapter.assignId(t)}else{var a=$tm.indeces.idByT[e];if(!a)return;var r=utils.getTiddlerWithField("tmap.id",a);if(r){$tm.logger("warn","[Renamed]",e,"into",r)}else{$tm.adapter.deleteNode(a)}}};var cleanup=function(){utils.deleteByPrefix("$:/temp/felixhayashi");utils.deleteByPrefix("$:/temp/tiddlymap");utils.deleteByPrefix("$:/temp/tmap")};var setDefaults=function(){var e=$tm.config.sys.defaultView;if(!e)return;utils.setField($tm.ref.defaultViewHolder,"text",e)};var maybePrepareForFullscreenStart=function(e){if(!e.query["tmap-enlarged"])return;var t=$tm.ref;var i=utils.getTiddlersByPrefix("$:/state/tab/sidebar-")[0];utils.setText(i,t.mainEditor);var a=new ViewAbstraction(e.query["tmap-view"]);if(a.exists()){utils.setField(t.defaultViewHolder,"text",a.getLabel())}};var createMetaFile=function(){if(utils.tiddlerExists($tm.ref.sysMeta))return;$tm.logger("warn","Creating meta file");var e=$tw.wiki.getTiddler($tm.path.pluginRoot);$tw.wiki.setTiddlerData($tm.ref.sysMeta,{originalVersion:e.fields.version,dataStructureState:"0.6.9",showWelcomeMessage:true})};