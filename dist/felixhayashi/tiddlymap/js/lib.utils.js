/*\

title: $:/plugins/felixhayashi/tiddlymap/js/utils
type: application/javascript
module-type: library

@preserve

\*/
"use strict";module.exports={};var vis=require("$:/plugins/felixhayashi/vis/vis.js");var exception=require("$:/plugins/felixhayashi/tiddlymap/js/exception");var URL=require("$:/plugins/felixhayashi/tiddlymap/js/URL");var utils=module.exports;utils.deleteTiddlers=function(e){var t=Object.keys(e);var i=$tw.wiki.getTiddlerList("$:/StoryList");for(var r=t.length;r--;){var n=utils.getTiddlerRef(e[t[r]]);if(!$tw.wiki.tiddlerExists(e[t[r]])){continue}var l=i.indexOf(n);if(l!==-1){i.splice(l,1);utils.setField("$:/StoryList","list",i)}$tw.wiki.deleteTiddler(n)}};utils.moveFieldValues=function(e,t,i,r,n){if(e===t)return;var l=n||$tw.wiki.allTitles();for(var u=l.length;u--;){var s=utils.getTiddler(l[u]);if(s.isDraft()||!s.fields[e]||!r&&$tw.wiki.isSystemTiddler(l[u])){continue}var a={};a[t]=s.fields[e];if(i){a[e]=undefined}$tw.wiki.addTiddler(new $tw.Tiddler(s,a))}};utils.getLabel=function(e,t){var i=utils.getTiddler(e);return i&&i.fields[t]?i.fields[t]:i.fields.title};utils.ucFirst=function(e){return e&&e[0].toUpperCase()+e.slice(1)};utils.convert=function(e,t){if(typeof e!=="object")return;switch(t){case"array":return utils.getValues(e);case"hashmap":case"object":if(e instanceof vis.DataSet){return e.get({returnType:"Object"})}else{return e}case"dataset":default:if(e instanceof vis.DataSet){return e}if(!Array.isArray(e)){e=utils.getValues(e)}return new vis.DataSet(e)}};utils.getValues=function(e){if(Array.isArray(e)){return e}else if(e instanceof vis.DataSet){return e.get({returnType:"Array"})}var t=[];var i=Object.keys(e);for(var r=i.length;r--;){t.push(e[i[r]])}return t};utils.getDataUri=function(e,t,i){var r=utils.getTiddler(e);var t=t||r.fields.type||"image/svg+xml";var n=r.fields.text;var l=$tw.config.contentTypeInfo[t].encoding;if(t==="image/svg+xml"){n=n.replace(/\r?\n|\r/g," ");if(!utils.hasSubString("xmlns",n)){n=n.replace(/<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')}}if(i&&l!=="base64"){l="base64";n=window.btoa(n)}return"data:"+t+";"+l+","+n};utils.hasOwnProp=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};utils.makeHashMap=function(){var e=Object.create(null);Object.defineProperty(e,"hasOwnProperty",{enumerable:false,configurable:false,writable:false,value:Object.prototype.hasOwnProperty.bind(e)});return e};utils.getMatches=function(e,t){var i=undefined;if(typeof e==="string"){e=$tw.wiki.compileFilter(e)}if(t!=null&&typeof t==="object"){var r=$tw.wiki;if(!Array.isArray(t)){t=Object.keys(t)}i=function(e){for(var i=t.length;i--;){var n=r.getTiddler(t[i]);e(n,t[i])}}}return e.call($tw.wiki,i)};var eTyFiltAutoPrefix="[all[]] ";utils.getEdgeTypeMatches=function(e,t){if(!t){var i=$tm.path.edgeTypes+"/";t=utils.getTiddlersByPrefix(i,{iterator:"eachTiddlerPlusShadows",removePrefix:true})}if(t!=null&&!Array.isArray(t)){t=Object.keys(t)}return utils.getMatches(eTyFiltAutoPrefix+(e||""),t)};utils.isEdgeTypeMatch=function(e,t){return utils.isMatch(e,eTyFiltAutoPrefix+(t||""))};utils.isMatch=function(e,t){var i=utils.getTiddlerRef(e);var r=utils.getMatches(t,[i]);return i===r[0]};utils.isInteger=Number.isInteger||function(e){return typeof e==="number"&&isFinite(e)&&Math.floor(e)===e};utils.escapeRegex=function(e){return e.replace(/[-$^?.+*[\]\\(){}|]/g,"\\$&")};utils.replaceAll=function(e,t,i){t=t||"";for(var r=i.length;r--;){var n=i[r];var l=t;if(Array.isArray(n)){l=n[1];n=n[0]}e=e.replace(n,l)}return e};utils.isTrue=function(e,t){if(e==null){return!!t}else if(typeof e==="string"){var i=parseInt(e);return isNaN(i)?e==="true":i!==0}else if(typeof e==="boolean"){return e}else if(typeof e==="number"){return i!==0}return false};utils.getTiddlerRef=function(e){if(e instanceof $tw.Tiddler){return e.fields.title}else if(typeof e==="string"){return e}};utils.getTiddlerNode=function(e){var t=utils.getTiddlerRef(e);return{type:"tiddler",attributes:{tiddler:{type:"string",value:t}},children:[]}};utils.getTranscludeNode=function(e,t){var i=utils.getTiddlerRef(e);return{type:"transclude",attributes:{tiddler:{type:"string",value:i}},children:[],isBlock:!!t}};utils.getElementNode=function(e,t,i){var r={type:"element",tag:e,attributes:{"class":{type:"string",value:i}},children:[]};if(t){r.children.push({type:"text",text:t})}return r};utils.registerTransclude=function(e,t,i,r){utils.removeArrayElement(e.children,e[t]);var n=utils.getTiddlerNode(i);n.children.push(utils.getTranscludeNode(null,true));e[t]=e.makeChildWidget(n);e.children.push(e[t]);return e[t]};utils.getTiddler=function(e,t){if(e instanceof $tw.Tiddler){if(!t){return e}e=e.fields.title}return $tw.wiki.getTiddler(e)};utils.getBasename=function(e){return e.substring(e.lastIndexOf("/")+1)};utils.notify=function(e){var t="$:/temp/tiddlymap/notify";$tw.wiki.addTiddler(new $tw.Tiddler({title:t,text:e}));$tw.notifier.display(t)};utils.tiddlerExists=function(e){var t=utils.getTiddlerRef(e);return t&&($tw.wiki.tiddlerExists(t)||$tw.wiki.isShadowTiddler(t))};utils.isPreviewed=function(e){if(e){if(e.getVariable("tv-tiddler-preview")){return true}else{var t="tc-tiddler-preview-preview";return!!utils.getAncestorWithClass(e.parentDomNode,t)}}return false};utils.getAncestorWithClass=function(e,t){if(typeof e!=="object"||typeof t!=="string")return;while(e.parentNode){e=e.parentNode;if($tw.utils.hasClass(e,t)){return e}}};utils.getPropertiesByPrefix=function(e,t,i){var r=utils.makeHashMap();for(var n in e){if(utils.startsWith(n,t)){r[i?n.substr(t.length):n]=e[n]}}return r};utils.getWithoutPrefix=function(e,t){return utils.startsWith(e,t)?e.substr(t.length):e};utils.hasKeyWithPrefix=function(e,t){for(var i in e){if(utils.startsWith(i,t)){return true}}return false};utils.startsWith=function(e,t){return e.substring(0,t.length)===t};utils.hasElements=function(e){return Object.keys(e).length>0};utils.groupByProperty=function(e,t){e=utils.getIterableCollection(e);var i=utils.makeHashMap();var r=Object.keys(e);for(var n in r){var l=e[r[n]];var u=l[t];if(u==null){throw"Cannot group by property "+t}else{if(!Array.isArray(i[u])){i[u]=[]}i[u].push(l)}}return i};utils.findAndRemoveClassNames=function(e){for(var t=e.length;t--;){var i=document.getElementsByClassName(e[t]);for(var r=i.length;r--;){$tw.utils.removeClass(i[r],e[t])}}};utils.parseFieldData=function(e,t,i){var r=utils.getTiddler(e);if(!r)return i;if(!t)t="text";return utils.parseJSON(r.fields[t],i)};utils.getImgFromWeb=function(e,t){if(!e||typeof t!=="function")return;var i=new XMLHttpRequest;i.open("GET",e,true);i.responseType="blob";i.onerror=function(e){console.log(e)};i.onload=function(e){if(this.readyState===4&&this.status===200){var i=this.response;t(window.URL.createObjectURL(i))}};try{i.send()}catch(r){console.log(r)}};utils.parseJSON=function(e,t){try{return JSON.parse(e)}catch(i){return t}};utils.writeFieldData=function(e,t,i,r){if(typeof i!=="object"){return}r=r>0&&t==="text"?r:0;utils.setField(e,t,JSON.stringify(i,null,r))};utils.getPrettyFilter=function(e){e=e.trim().replace("][","] [");var t=/[\+\-]?\[.+?[\]\}\>]\]/g;var i=e.match(t);e=e.replace(t," [] ").trim();var r=e.split(/\s+/);var n=0;var l=[];for(var u=0;u<r.length;u++){l[u]=r[u]==="[]"?i[n++]:r[u]}return l.join("\n")};utils.setField=function(e,t,i){if(!e||!t)return;var r=utils.getTiddlerRef(e);var n={title:r};n[t]=i;var l=$tw.wiki.getTiddler(r,true);if(t!=="text"&&l&&!l.fields.text){n.text=""}var l=new $tw.Tiddler(l,n);$tw.wiki.addTiddler(l);return l};utils.clone=function(e,t){utils.setField(e,"title",t)};utils.setEntry=function(e,t,i){$tw.wiki.setText(utils.getTiddlerRef(e),null,t,i)};utils.getEntry=function(e,t,i){var r=$tw.wiki.getTiddlerData(utils.getTiddlerRef(e),{});return r[t]==null?i:r[t]};utils.isLeftVersionGreater=function(e,t){return e!==t&&$tw.utils.checkVersions(e,t)};utils.getField=function(e,t,i){var r=utils.getTiddler(e);return!r?i||"":r.fields[t]||i||""};utils.getText=function(e,t){return utils.getField(e,"text",t)};utils.setText=function(e,t){utils.setField(e,"text",t)};utils.getFirstElementByClassName=function(e,t,i){var r=(t||document).getElementsByClassName(e)[0];if(!r&&(typeof i==="boolean"?i:true)){var n="Missing element with class "+e+" inside "+t;throw new utils.exception.EnvironmentError(n)}return r};utils.isDraft=function(e){var t=utils.getTiddler(e);return t&&t.isDraft()};utils.getRandomInt=function(e,t){return Math.floor(Math.random()*(t-e)+e)};utils.pickRandom=function(e){return e[utils.getRandomInt(0,e.length-1)]};utils.getRandomLabel=function(e){e=e||{};var t=["exciting","notable","epic","new","fancy","great","cool","fresh","funky","clever"];var i=["concept","idea","thought","topic","subject"];return"My"+" "+utils.pickRandom(t)+" "+(e.object||utils.pickRandom(i))+(e.plural?"s":"")};utils.merge=function(){var e=function(t,i){if(typeof t!=="object"){t={}}for(var r in i){if(i.hasOwnProperty(r)){if(i[r]!=null){t[r]=typeof i[r]==="object"?e(t[r],i[r]):i[r]}}}return t};return function(t){for(var i=1,r=arguments.length;i<r;i++){var n=arguments[i];if(n!=null&&typeof n==="object"){t=e(t,n)}}return t}}();utils.drawRaster=function(e,t,i,r,n){var r=parseInt(r)||10;var l=e.canvas;var u=l.width/t;var s=l.width/t;var a=i.x-u/2;var f=i.y-s/2;for(var o=a;o<u;o+=r){e.moveTo(o,f);e.lineTo(o,s)}for(var d=f;d<s;d+=r){e.moveTo(a,d);e.lineTo(u,d)}e.strokeStyle=n||"#D9D9D9";e.stroke()};utils.isSystemOrDraft=function(e){if($tw.wiki.isSystemTiddler(utils.getTiddlerRef(e))){return true}var t=utils.getTiddler(e);return t&&t.isDraft()};utils.getMergedTiddlers=function(e,t){if(!Array.isArray(e))return;for(var i=e.length;i--;){e[i]=utils.getTiddler(e[i])}if(!e.length)return;e.push({title:t||e[0].fields.title},$tw.wiki.getModificationFields(),$tw.wiki.getCreationFields());e.unshift(null);return new(Function.prototype.bind.apply($tw.Tiddler,e))};utils.getChildWidgetByProperty=function(e,t,i){var r=e.children;for(var n=r.length;n--;){var l=r[n];if(l[t]===i){return l}else{l=utils.getChildWidgetByProperty(l,t,i);if(l){return l}}}};utils.setDomListeners=function(e,t,i,r){r=typeof r==="boolean"?r:false;e=e+"EventListener";for(var n in i){var l=i[n];if(typeof l==="function"){t[e](n,l,r)}else{t[e](n,l[0],typeof l[1]==="boolean"?l[1]:r)}}};utils.removeArrayElement=function(e,t){var i=e.indexOf(t);if(i>-1){return e.splice(i,1)[0]}};utils.removeDOMChildNodes=function(e){for(var t=e.childNodes.length;t--;){e.removeChild(e.childNodes[t])}};utils.addTWlisteners=function(e,t,i){for(var r in e){t.addEventListener(r,e[r].bind(i))}};utils.bind=function(e,t){if(typeof t==="string"){t=[t]}else{for(var i=t.length;i--;){var r=e[t[i]];if(typeof r==="function"){e[t[i]]=r.bind(e)}}}};utils.mv=function(e,t,i,r){if(e===t||!e||!t)return;i=typeof i==="boolean"?i:false;r=typeof r==="boolean"?r:true;var n=utils.getTiddlersByPrefix(e);var l=utils.makeHashMap();for(var u=n.length;u--;){var s=n[u];var a=s.replace(e,t);if($tw.wiki.tiddlerExists(a)&&!i){return}l[s]=a}for(var s in l){utils.setField(s,"title",l[s]);if(r)$tw.wiki.deleteTiddler(s)}return l};utils.cp=function(e,t,i){return utils.mv(e,t,i,false)};utils.inArray=function(e,t){return t.indexOf(e)!==-1};utils.hasSubString=function(e,t){return e.indexOf(t)!==-1};utils.joinAndWrap=function(e,t,i,r){if(!r)r=" ";return t+e.join(i+r+t)+i};utils.keysOfItemsWithProperty=function(e,t,i,r){e=utils.getIterableCollection(e);var n=Object.keys(e);var l=[];var r=typeof r==="number"?r:n.length;for(var u=0,s=n.length;u<s;u++){var a=n[u];if(typeof e[a]==="object"&&e[a][t]){if(!i||e[a][t]===i){l.push(a);if(l.length===r){break}}}}return l};utils.keyOfItemWithProperty=function(e,t,i){var r=utils.keysOfItemsWithProperty(e,t,i,1);return r.length?r[0]:undefined};utils.deleteByPrefix=function(e,t){if(!e)return;t=t||$tw.wiki.allTitles();var i=[];for(var r=t.length;r--;){if(utils.startsWith(t[r],e)){$tw.wiki.deleteTiddler(t[r]);i.push(i[r])}}return i};utils.getIterableCollection=function(e){return e instanceof vis.DataSet?e.get():e};utils.getLookupTable=function(e,t){e=utils.getIterableCollection(e);var i=utils.makeHashMap();var r=Object.keys(e);for(var n=0,l=r.length;n<l;n++){var u=r[n];var s=t?e[u][t]:e[u];var a=typeof s;if(a==="string"&&s!==""||a==="number"){if(!i[s]){i[s]=t?e[u]:true;continue}}throw'TiddlyMap: Cannot use "'+ltIndex+'" as lookup table index'}return i};utils.getWithoutNewLines=function(e){if(typeof e==="string"){return e.replace(/[\n\r]/g," ")}};utils.getArrayValuesAsHashmapKeys=function(e){return utils.getLookupTable(e)};utils.getTiddlersWithField=function(e,t,i){if(!i||typeof i!=="object")i={};var r=i.tiddlers||$tw.wiki.allTitles();var n=i.limit||0;var l=i.isIncludeDrafts===true;var u=utils.makeHashMap();var s=Object.keys(r);var a=$tw.utils.hop;for(var f=s.length;f--;){var o=utils.getTiddler(r[s[f]]);var d=o.fields;if(a(d,e)&&(!a(d,"draft.of")||l)){if(!t||d[e]===t){u[d.title]=o;if(--n===0)break}}}return u};utils.getTiddlerWithField=function(e,t){var i=utils.getTiddlersWithField(e,t,{limit:1});return Object.keys(i)[0]};utils.getTiddlersByPrefix=function(e,t){t=t||{};var i=t.removePrefix===true;var r=[];$tw.wiki[t.iterator||"each"](function(t,n){if(utils.startsWith(n,e)){r.push(i?utils.getWithoutPrefix(n,e):n)}});return r};utils.addTiddler=function(e,t){var i=utils.getTiddler(e);if(!t&&i)return i;i=new $tw.Tiddler({title:e,text:""},$tw.wiki.getModificationFields(),$tw.wiki.getCreationFields());$tw.wiki.addTiddler(i);return i};utils.getSnapshotTitle=function(e,t){return"Snapshot – "+e+" ("+(new Date).toDateString()+")"+"."+(t||"png")};utils.exception=exception;utils.URL=URL;utils.makeDraftTiddler=function(e){var t=$tw.wiki.findDraft(e);if(t){return $tw.wiki.getTiddler(t)}var i=$tw.wiki.getTiddler(e);t=utils.generateDraftTitle(e);var r=new $tw.Tiddler(i,{title:t,"draft.title":e,"draft.of":e},$tw.wiki.getModificationFields());$tw.wiki.addTiddler(r);return r};utils.generateDraftTitle=function(e){var t=0,i;do{i="Draft "+(t?t+1+" ":"")+"of '"+e+"'";t++}while($tw.wiki.tiddlerExists(i));return i};utils.touch=function(e){utils.setField(e,"modified",new Date)};utils.getFullScreenApis=function(){var e=document,t=e.body,i={_requestFullscreen:t.webkitRequestFullscreen!==undefined?"webkitRequestFullscreen":t.mozRequestFullScreen!==undefined?"mozRequestFullScreen":t.msRequestFullscreen!==undefined?"msRequestFullscreen":t.requestFullscreen!==undefined?"requestFullscreen":"",_exitFullscreen:e.webkitExitFullscreen!==undefined?"webkitExitFullscreen":e.mozCancelFullScreen!==undefined?"mozCancelFullScreen":e.msExitFullscreen!==undefined?"msExitFullscreen":e.exitFullscreen!==undefined?"exitFullscreen":"",_fullscreenElement:e.webkitFullscreenElement!==undefined?"webkitFullscreenElement":e.mozFullScreenElement!==undefined?"mozFullScreenElement":e.msFullscreenElement!==undefined?"msFullscreenElement":e.fullscreenElement!==undefined?"fullscreenElement":"",_fullscreenChange:e.webkitFullscreenElement!==undefined?"webkitfullscreenchange":e.mozFullScreenElement!==undefined?"mozfullscreenchange":e.msFullscreenElement!==undefined?"MSFullscreenChange":e.fullscreenElement!==undefined?"fullscreenchange":""};if(!i._requestFullscreen||!i._exitFullscreen||!i._fullscreenElement){return null}else{return i}};utils.flatten=function(e,t){t=t||{};var i=t.delimiter||".";var r=t.prefix||"";var n={};function l(e,u){Object.keys(e).forEach(function(s){var a=e[s];var f=t.safe&&Array.isArray(a);var o=Object.prototype.toString.call(a);var d=o==="[object Object]"||o==="[object Array]";var c=u?u+i+s:r+s;if(!f&&d){return l(a,c)}n[c]=a})}l(e);return n};utils.unflatten=function(e,t){t=t||{};var i=t.delimiter||".";var r={};if(Object.prototype.toString.call(e)!=="[object Object]"){return e}function n(e){var t=Number(e);return isNaN(t)||e.indexOf(".")!==-1?e:t}Object.keys(e).forEach(function(l){var u=l.split(i);var s=n(u.shift());var a=n(u[0]);var f=r;while(a!==undefined){if(f[s]===undefined){f[s]=typeof a==="number"&&!t.object?[]:{}}f=f[s];if(u.length>0){s=n(u.shift());a=n(u[0])}}f[s]=utils.unflatten(e[l],t)});return r};utils.genUUID=function(){var e="0123456789abcdefghijklmnopqrstuvwxyz".split("");return function(){var t=e,i=new Array(36);var r=0,n;for(var l=0;l<36;l++){if(l==8||l==13||l==18||l==23){i[l]="-"}else if(l==14){i[l]="4"}else{if(r<=2)r=33554432+Math.random()*16777216|0;n=r&15;r=r>>4;i[l]=t[l==19?n&3|8:n]}}return i.join("")}}();