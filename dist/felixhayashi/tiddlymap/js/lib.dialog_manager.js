/*\

title: $:/plugins/felixhayashi/tiddlymap/js/DialogManager
type: application/javascript
module-type: library

@preserve

\*/
"use strict";module.exports=DialogManager;var utils=require("$:/plugins/felixhayashi/tiddlymap/js/utils");var CallbackManager=require("$:/plugins/felixhayashi/tiddlymap/js/CallbackManager");function DialogManager(t,e){this.callbackManager=t;if(e){this.context=e}}DialogManager.prototype.open=function(t,e,i){if(utils.isTrue($tm.config.sys.suppressedDialogs[t],false)){$tm.logger("warning","Suppressed dialog",t);return}e=e||{};$tm.logger("debug","Dialog param object",e);if(typeof i==="function"&&this.context){i=i.bind(this.context)}var a=$tm.path.tempRoot+"/dialog-"+utils.genUUID();var l=utils.getTiddler($tm.path.dialogs+"/"+t);var r={title:a,buttons:l.fields["buttons"]||"ok_cancel",classes:"tmap-modal-content "+l.fields["classes"],output:a+"/output",result:a+"/result",temp:a+"/temp",template:l.fields.title,templateId:t,currentTiddler:a+"/output",text:utils.getText($tm.path.dialogs)};if(e.dialog){if(e.dialog.preselects){$tw.wiki.addTiddler(new $tw.Tiddler({title:r.output},utils.flatten(e.dialog.preselects)));delete e.dialog.preselects}utils.merge(r,e.dialog)}r.footer=utils.getText($tm.path.footers);r=utils.flatten(r);e=utils.flatten(e);var s=function(t){this.getElement("hidden-close-button").click();var e=$tw.wiki.getTiddler(t);var l=e.fields.text;if(l){var s=$tw.wiki.getTiddler(r.output)}else{var s=null;$tm.notify("operation cancelled")}if(typeof i==="function"){i(l,s)}utils.deleteByPrefix(a)}.bind(this);this.callbackManager.add(r.result,s,true);var n=new $tw.Tiddler(l,e,r);$tw.wiki.addTiddler(n);$tm.logger("debug","Opening dialog",n);$tw.rootWidget.dispatchEvent({type:"tm-modal",param:n.fields.title,paramObject:n.fields});this.addKeyBindings();return n};DialogManager.prototype.getElement=function(t){return utils.getFirstElementByClassName("tmap-"+t)};DialogManager.prototype.addKeyBindings=function(){var t=$tm.keycharm({container:utils.getFirstElementByClassName("tc-modal")});var e=/tmap-triggers-(.+?)-on-(.+?)(?:\s|$)/;var i=document.getElementsByClassName("tmap-trigger-field");for(var a=i.length;a--;){var l=i[a].className.split(" ");for(var r=l.length;r--;){var s=l[r].match(e);if(!s){continue}var n=s[1];var o=s[2];var d=this.getElement(n);if(!d)continue;t.bind(o,function(){this.click()}.bind(d))}}};