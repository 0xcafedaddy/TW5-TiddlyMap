/*\

title: $:/plugins/felixhayashi/tiddlymap/js/Adapter
type: application/javascript
module-type: library

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var e=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction").ViewAbstraction;var t=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var i=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType").NodeType;var r=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var s=require("$:/core/modules/macros/contrastcolour.js").run;var a=require("$:/plugins/felixhayashi/vis/vis.js");var o=function(){this.opt=$tw.tmap.opt;this.logger=$tw.tmap.logger;this.indeces=$tw.tmap.indeces;this.visShapesWithTextInside=r.getLookupTable(["ellipse","circle","database","box","text"]);this.isTransTypeEnabled=typeof $tw.wiki.getTiddlerTranscludes==="function"};o.prototype.deleteEdge=function(e){return this._processEdge(e,"delete")};o.prototype.deleteEdges=function(e){e=r.convert(e,"array");for(var t=e.length;t--;){this.deleteEdge(e[t])}};o.prototype.insertEdge=function(e){return this._processEdge(e,"insert")};o.prototype._processEdge=function(e,i){this.logger("debug","Edge",i,e);if(typeof e!=="object"||!i||!e.from)return;if(i==="insert"&&!e.to)return;var s=this.indeces.tById[e.from];if(!s||!r.tiddlerExists(s))return;var a=new t(e.type);var o=r.getTiddler(s);var n=a.namespace;if(n==="tw-list"){if(!e.to)return;return this._processListEdge(o,e,a,i)}else if(n==="tw-field"){if(!e.to)return;return this._processFieldEdge(o,e,a,i)}else if(n==="tw-body"){return null}else{return this._processTmapEdge(o,e,a,i)}return e};o.prototype._processTmapEdge=function(e,t,i,s){if(s==="delete"&&!t.id)return;var a=r.parseFieldData(e,"tmap.edges",{});if(s==="insert"){t.id=t.id||r.genUUID();a[t.id]={to:t.to,type:i.id};if(!i.exists()){i.save()}}else{delete a[t.id]}r.writeFieldData(e,"tmap.edges",a);return t};o.prototype._processListEdge=function(e,t,i,s){var a=i.getId(true);var o=r.getTiddler(e);var n=$tw.utils.parseStringArray(e.fields[a]);n=(n||[]).slice();var d=this.indeces.tById[t.to];if(s==="insert"){n.push(d);if(!i.exists()){i.save()}}else{var l=n.indexOf(d);if(l>-1){n.splice(l,1)}}r.setField(o,a,$tw.utils.stringifyList(n));return t};o.prototype._processFieldEdge=function(e,t,i,s){var a=this.indeces.tById[t.to];if(a==null)return;var o=s==="insert"?a:"";r.setField(e,i.getId(true),o);if(!i.exists()){i.save()}return t};o.prototype.getAdjacencyList=function(e,t){$tw.tmap.start("Creating adjacency list");t=t||{};if(!t.edges){var i=r.getMatches(this.opt.selector.allPotentialNodes);t.edges=this.getEdgesForSet(i,t.toWL,t.typeWL)}var s=r.groupByProperty(t.edges,e||"to");$tw.tmap.stop("Creating adjacency list");return s};o.prototype.getNeighbours=function(t,i){$tw.tmap.start("Get neighbours");i=i||{};var s=r.getArrayValuesAsHashmapKeys(t);var a=new e(i.view);var o=i.addProperties;var n=r.getDataMap();var d=this.indeces.allETy;var l=r.getDataMap();var p=i.toWL;var g=i.typeWL;var f=this.indeces.tById;var c=this.indeces.idByT;var u=parseInt(i.steps)>0?i.steps:1;var v=a.getConfig("neighbourhood_directions")||i.direction;var h=!v||v==="both";var y=h||v==="in";var w=h||v==="out";var m=this.getAdjacencyList("to",i);var T=function(e,t){n[e.id]=e;var i=f[e[t]];if(!s[i]){s[i]=true;var r=this.makeNode(i,o);if(r){l[r.id]=r;E.push(i)}}}.bind(this);for(var b=0;b<u&&t.length;b++){var E=[];for(var N=t.length;N--;){if(r.isSystemOrDraft(t[N])){continue}var $=this.getEdges(t[N],p,g);for(var x in $){var I=d[$[x].type];if(h||w&&I.toArrow||y&&I.invertedArrow){T($[x],"to")}}var k=m[c[t[N]]];if(!k)continue;for(var A=k.length;A--;){var I=d[k[A].type];if(h||y&&I.toArrow||w&&I.invertedArrow){T(k[A],"from")}}}t=E}var _={nodes:l,edges:n};this.logger("debug","Retrieved neighbourhood",_,"steps",b);$tw.tmap.stop("Get neighbours");return _};o.prototype.getGraph=function(t){$tw.tmap.start("Assembling Graph");t=t||{};var i=new e(t.view);var s=r.getMatches(t.filter||i.getNodeFilter("compiled"));var a=r.getArrayValuesAsHashmapKeys(s);var o=t.edgeTypeWL||this.getEdgeTypeWhiteList(i.getEdgeFilter("compiled"));var n=parseInt(t.neighbourhoodScope||i.getConfig("neighbourhood_scope"));var d={edges:this.getEdgesForSet(s,a,o),nodes:this.selectNodesByReferences(s,{view:i,outputType:"hashmap"})};if(n){var l=this.getNeighbours(s,{steps:n,view:i,typeWL:o,addProperties:{group:"tmap:neighbour"}});r.merge(d,l);if(i.isEnabled("show_inter_neighbour_edges")){var p=this.getTiddlersById(l.nodes);var a=r.getArrayValuesAsHashmapKeys(p);$tw.utils.extend(d.edges,this.getEdgesForSet(p,a))}}this._removeObsoleteViewData(d.nodes,i);this.attachStylesToNodes(d.nodes,i);$tw.tmap.stop("Assembling Graph");this.logger("debug","Assembled graph:",d);return d};o.prototype.getEdges=function(e,t,i){var s=r.getTiddler(e);if(!s||r.isSystemOrDraft(s))return;var a=r.getDataMap();this._addTmapEdges(a,s,t,i);this._addBodyAndFieldEdges(a,s,t,i);return a};o.prototype._addBodyAndFieldEdges=function(e,t,i,s){var a=t.fields;var o=r.getTiddlerRef(t);var n=this.indeces;var d=n.fiETy;var l=n.liETy;var p=n.maETyFiNa;var g=r.getDataMap();if(!s||s["tw-body:link"]){g["tw-body:link"]=$tw.wiki.getTiddlerLinks(o)}if(this.isTransTypeEnabled&&(!s||s["tw-body:transclude"])){g["tw-body:transclude"]=$tw.wiki.getTiddlerTranscludes(o)}for(var f in a){if(!p[f])continue;var c=d["tw-field:"+f]||l["tw-list:"+f];if(s&&!s[c.id])continue;if(d[c.id]){g[c.id]=[a[f]]}else if(l[c.id]){g[c.id]=$tw.utils.parseStringArray(a[f])}}if(!g)return;var u=t.fields["tmap.id"];var v=n.idByT;var h=n.allETy;for(var y in g){var w=g[y];if(!w)continue;var c=h[y];for(var m=w.length;m--;){var T=w[m];if(!T||!$tw.wiki.tiddlerExists(T)||r.isSystemOrDraft(T)||i&&!i[T])continue;var b=c.id+$tw.utils.hashString(o+T);var E=this.makeEdge(u,v[T],c,b);if(E){e[E.id]=E}}}};o.prototype._addTmapEdges=function(e,t,i,s){var a=r.parseFieldData(t,"tmap.edges");if(!a)return;var o=this.indeces.tById;var n=t.fields["tmap.id"];for(var d in a){var l=a[d];var p=o[l.to];if(p&&(!i||i[p])&&(!s||s[l.type])){var g=this.makeEdge(n,l.to,l.type,d);if(g){e[d]=g}}}};o.prototype.getEdgeTypeWhiteList=function(e){var i=r.getDataMap();var s=r.getMatches(this.opt.selector.allEdgeTypes);var a=e?r.getMatches(e,s):s;for(var o=a.length;o--;){var n=new t(a[o]);i[n.id]=true}return i};o.prototype.getEdgesForSet=function(e,t,i){var s=r.getDataMap();for(var a=e.length;a--;){$tw.utils.extend(s,this.getEdges(e[a],t,i))}return s};o.prototype.selectEdgesByType=function(e){var i=r.getDataMap();i[new t(e).id]=true;return this.getEdgesForSet(this.getAllPotentialNodes(),null,i)};o.prototype.getAllPotentialNodes=function(){return r.getMatches(this.opt.selector.allPotentialNodes)};o.prototype._processEdgesWithType=function(e,i){e=new t(e);this.logger("debug","Processing edges",e,i);var r=this.selectEdgesByType(e);if(i.action==="rename"){var s=new t(i.newName);s.load(e);s.save()}for(var a in r){this._processEdge(r[a],"delete");if(i.action==="rename"){r[a].type=i.newName;this._processEdge(r[a],"insert")}}$tw.wiki.deleteTiddler(e.fullPath)};o.prototype.selectNodesByFilter=function(e,t){var i=r.getMatches(e);return this.selectNodesByReferences(i,t)};o.prototype.selectNodesByReferences=function(e,t){t=t||{};var i=t.addProperties;var s=r.getDataMap();var a=Object.keys(e);for(var o=a.length;o--;){var n=this.makeNode(e[a[o]],i);if(n){s[n.id]=n}}return r.convert(s,t.outputType)};o.prototype.selectNodesByIds=function(e,t){var i=this.getTiddlersById(e);return this.selectNodesByReferences(i,t)};o.prototype.selectNodeById=function(e,t){t=r.merge(t,{outputType:"hashmap"});var i=this.selectNodesByIds([e],t);return i[e]};o.prototype.makeEdge=function(e,i,s,a){if(!e||!i)return;if(e instanceof $tw.Tiddler){e=e.fields["tmap.id"]}else if(typeof e==="object"){e=e.id}s=this.indeces.allETy[s]||new t(s);var o=s.getLabel();var n={id:a||r.genUUID(),from:e,to:i,type:s.id};var d=s.description;n.title=d||o||n.id;if(r.isTrue(s["show-label"],true)){n.label=o}n=$tw.utils.extend(n,s.style);return n};o.prototype.removeNodeType=function(e){var e=new i(e);$tw.wiki.deleteTiddler(e.fullPath)};o.prototype.makeNode=function(e,t){var i=r.getTiddler(e);if(!i||i.isDraft()||$tw.wiki.isSystemTiddler(i.fields.title)){return}var s=r.merge({},t);s.id=this.assignId(i);var a=i.fields[this.opt.field.nodeLabel];s.label=a&&this.opt.field.nodeLabel!=="title"?$tw.wiki.renderText("text/plain","text/vnd-tiddlywiki",a):i.fields.title;return s};o.prototype.getInheritedNodeStyles=function(t,i){i=i?new e(i).getLabel():null;var s=this.getTiddlersById(t);var a={};var o=this.indeces.glNTy;for(var n=o.length;n--;){var d=o[n];if(d.id==="tmap:neighbour"){var l=$tw.tmap.indeces.tById;var p=[];for(var g in t){if(t[g].group==="tmap:neighbour"){p.push(l[g])}}}else{var p=d.getInheritors(s)}for(var f=p.length;f--;){var c=p[f];var u=a[c]=a[c]||{};u.style=r.merge(u.style||{},d.style);if(d["fa-icon"]){u["fa-icon"]=d["fa-icon"]}else if(d["tw-icon"]){u["tw-icon"]=d["tw-icon"]}}}return a};o.prototype.attachStylesToEdges=function(e,t){};o.prototype._removeObsoleteViewData=function(t,i){i=new e(i);if(!i.exists()||!t)return;var r=i.getNodeData();var s=0;for(var a in r){if(t[a]===undefined&&r[a]!=null){r[a]=undefined;s++}}if(s){this.logger("debug","[Cleanup]","Removed obsolete node data:",i.getLabel(),s);i.saveNodeData(r)}};o.prototype.attachStylesToNodes=function(t,i){i=new e(i);var a=this.getInheritedNodeStyles(t,i);var o=i.getNodeData();var n=!i.isEnabled("physics_mode");var d=this.opt.field.nodeInfo;var l=this.opt.field.nodeIcon;var p=this.indeces.tById;for(var g in t){var f=p[g];var c=$tw.wiki.getTiddler(f);var u=c.fields;var v=t[g];var h=null;var y=null;if(a[f]){if(a[f].style){r.merge(v,a[f].style)}h=a[f]["fa-icon"];y=a[f]["tw-icon"]}if(u.color){v.color=u.color}if(u["tmap.style"]){r.merge(v,r.parseJSON(u["tmap.style"]))}h=u["tmap.fa-icon"]||h;y=u["icon"]||y;if(o[g]){r.merge(v,o[g]);if(n){v.fixed={x:v.x!=null,y:v.y!=null}}h=o[g]["fa-icon"]||h;y=o[g]["tw-icon"]||y}var w=v.color!==null&&typeof v.color==="object";var m=w?v.color.background:v.color;v.color={background:m,border:w?v.color.border:undefined};this._addNodeIcon(v,h,y);v.font=v.font||{};if(v.shape&&!this.visShapesWithTextInside[v.shape]){v.font.color="black"}else if(!v.font.color&&m){v.font.color=s(m,m,"black","white")}if(v.shape==="icon"&&typeof v.icon==="object"){v.icon.color=m}if(u[d]){v.title=$tw.wiki.renderText("text/html","text/vnd-tiddlywiki",u[d])}else if(v.label!==f){v.title=f}}};o.prototype.deleteNode=function(t){if(!t)return;var i=typeof t==="object"?t.id:t;var s=this.indeces.tById[i];if(s){r.deleteTiddlers([s])}var a=$tw.tmap.opt.selector.allViews;var o=r.getMatches(a);for(var n=o.length;n--;){var d=new e(o[n]);d.removeNodeFromFilter(i);if(d.getNodeData(i)){d.saveNodeData(i,null)}}var l=this.getNeighbours([s]);this.deleteEdges(l.edges)};o.prototype.deleteNodes=function(e){e=r.convert(e,"array");for(var t=e.length;t--;){this.deleteNode(e[t])}};o.prototype.getView=function(t,i){return new e(t,i)};o.prototype.createView=function(t){return new e(t,true)};o.prototype.storePositions=function(t,i){i=new e(i);i.saveNodeData(t)};o.prototype.assignId=function(e,t){var i=r.getTiddler(e,true);if(!i)return;var s=i.fields["tmap.id"];if(!s||t){s=r.genUUID();r.setField(i,"tmap.id",s);this.logger("info","Assigning new id to",i.fields.title)}this.indeces.tById[s]=i.fields.title;this.indeces.idByT[i.fields.title]=s;return s};o.prototype.insertNode=function(t,i,r){r=r||{};t=t||{};var s={"tmap.id":null};if(!r.fields||!r.fields.text){s.text=""}var a=$tw.wiki.generateNewTitle(t.label||"New node");t.label=s.title=a;var o=new $tw.Tiddler(r.fields,s,$tw.wiki.getModificationFields(),$tw.wiki.getCreationFields());$tw.wiki.addTiddler(o);t=this.makeNode(o,t);var i=new e(i);i.addNodeToView(t);return t};o.prototype._getFAdigits=function(e){return e.length===4?e:e.substr(3,4)};o.prototype.getTiddlersById=function(e){if(Array.isArray(e)){e=r.getArrayValuesAsHashmapKeys(e)}else if(e instanceof a.DataSet){e=r.getLookupTable(e,"id")}var t=[];var i=this.indeces.tById;for(var s in e){if(i[s])t.push(i[s])}return t};o.prototype.getId=function(e){return this.indeces.idByT[r.getTiddlerRef(e)]};o.prototype._addNodeIcon=function(e,t,i){if(t){e.shape="icon";e.icon={shape:"icon",face:"FontAwesome",color:e.color,code:String.fromCharCode("0x"+this._getFAdigits(t))};return}if(!i)return;var s=r.getTiddler(i);if(!s)return;if(s.fields["_canonical_uri"]){e.image=s.fields["_canonical_uri"];e.shape="image";return}if(s.fields.text){var a=s.fields.type||"image/svg+xml";var o=s.fields.text;if(a==="image/svg+xml"){o=o.replace(/\r?\n|\r/g," ");if(!r.inArray("xmlns",o)){o=o.replace(/<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')}}var n=$tw.config.contentTypeInfo[a].encoding==="base64"?o:window.btoa(o);e.image="data:"+a+";base64,"+n;e.shape="image";return}};exports.Adapter=o})();