/*\

title: $:/plugins/felixhayashi/tiddlymap/js/Adapter
type: application/javascript
module-type: library

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var e=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction").ViewAbstraction;var t=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var i=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType").NodeType;var r=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var s=require("$:/core/modules/macros/contrastcolour.js").run;var o=require("$:/plugins/felixhayashi/vis/vis.js");var a=function(){this.opt=$tw.tmap.opt;this.logger=$tw.tmap.logger;this.indeces=$tw.tmap.indeces;this.visShapesWithTextInside=r.getLookupTable(["ellipse","circle","database","box","text"])};a.prototype.deleteEdge=function(e){return this._processEdge(e,"delete")};a.prototype.deleteEdges=function(e){e=r.convert(e,"array");for(var t=e.length;t--;){this.deleteEdge(e[t])}};a.prototype.insertEdge=function(e){return this._processEdge(e,"insert")};a.prototype._processEdge=function(e,i){this.logger("debug","Edge",i,e);if(typeof e!=="object"||!i||!e.from)return;if(i==="insert"&&!e.to)return;var s=this.indeces.tById[e.from];if(!s||!r.tiddlerExists(s))return;var o=new t(e.type);var a=r.getTiddler(s);var n=o.namespace;if(n==="tw-list"){if(!e.to)return;return this._processListEdge(a,e,o,i)}else if(n==="tw-field"){if(!e.to)return;return this._processFieldEdge(a,e,o,i)}else if(n==="tw-body"){return null}else{return this._processTmapEdge(a,e,o,i)}return e};a.prototype._processTmapEdge=function(e,t,i,s){if(s==="delete"&&!t.id)return;var o=r.parseFieldData(e,"tmap.edges",{});if(s==="insert"){t.id=t.id||r.genUUID();o[t.id]={to:t.to,type:i.id};if(!i.exists()){i.save()}}else{delete o[t.id]}r.writeFieldData(e,"tmap.edges",o);return t};a.prototype._processListEdge=function(e,t,i,s){var o=i.getId(true);var a=r.getTiddler(e);var n=$tw.utils.parseStringArray(e.fields[o]);n=(n||[]).slice();var d=this.indeces.tById[t.to];if(s==="insert"){n.push(d);if(!i.exists()){i.save()}}else{var l=n.indexOf(d);if(l>-1){n.splice(l,1)}}r.setField(a,o,$tw.utils.stringifyList(n));return t};a.prototype._processFieldEdge=function(e,t,i,s){var o=this.indeces.tById[t.to];if(o==null)return;var a=s==="insert"?o:"";r.setField(e,i.getId(true),a);if(!i.exists()){i.save()}return t};a.prototype.getAdjacencyList=function(e,t){$tw.tmap.start("Creating adjacency list");t=t||{};if(!t.edges){var i=r.getMatches(this.opt.selector.allPotentialNodes);t.edges=this.getEdgesForSet(i,t.toWL,t.typeWL)}var s=r.groupByProperty(t.edges,e||"to");$tw.tmap.stop("Creating adjacency list");return s};a.prototype.getNeighbours=function(t,i){$tw.tmap.start("Get neighbours");i=i||{};var s=r.getArrayValuesAsHashmapKeys(t);var o=new e(i.view);var a=i.addProperties;var n=r.getDataMap();var d=this.indeces.allETy;var l=r.getDataMap();var p=i.toWL;var g=i.typeWL;var f=this.indeces.tById;var c=this.indeces.idByT;var v=parseInt(i.steps)>0?i.steps:1;var u=o.getConfig("neighbourhood_directions")||i.direction;var h=!u||u==="both";var y=h||u==="in";var w=h||u==="out";var m=this.getAdjacencyList("to",i);var b=function(e,t){n[e.id]=e;var i=f[e[t]];if(!s[i]){s[i]=true;var r=this.makeNode(i,a);if(r){l[r.id]=r;E.push(i)}}}.bind(this);for(var T=0;T<v&&t.length;T++){var E=[];for(var N=t.length;N--;){if(r.isSystemOrDraft(t[N])){continue}var $=this.getEdges(t[N],p,g);for(var x in $){var I=d[$[x].type];if(h||w&&I.toArrow||y&&I.invertedArrow){b($[x],"to")}}var A=m[c[t[N]]];if(!A)continue;for(var _=A.length;_--;){var I=d[A[_].type];if(h||y&&I.toArrow||w&&I.invertedArrow){b(A[_],"from")}}}t=E}var k={nodes:l,edges:n};this.logger("debug","Retrieved neighbourhood",k,"steps",T);$tw.tmap.stop("Get neighbours");return k};a.prototype.getGraph=function(t){$tw.tmap.start("Assembling Graph");t=t||{};var i=new e(t.view);var s=r.getMatches(t.filter||i.getNodeFilter("compiled"));var o=r.getArrayValuesAsHashmapKeys(s);var a=t.edgeTypeWL||this.getEdgeTypeWhiteList(i.getEdgeFilter("compiled"));var n=parseInt(t.neighbourhoodScope||i.getConfig("neighbourhood_scope"));var d={edges:this.getEdgesForSet(s,o,a),nodes:this.selectNodesByReferences(s,{view:i,outputType:"hashmap"})};if(n){var l=this.getNeighbours(s,{steps:n,view:i,typeWL:a,addProperties:{group:"tmap:neighbour"}});r.merge(d,l);if(i.isEnabled("show_inter_neighbour_edges")){var p=this.getTiddlersById(l.nodes);var o=r.getArrayValuesAsHashmapKeys(p);$tw.utils.extend(d.edges,this.getEdgesForSet(p,o))}}this._removeObsoleteViewData(d.nodes,i);this.attachStylesToNodes(d.nodes,i);$tw.tmap.stop("Assembling Graph");this.logger("debug","Assembled graph:",d);return d};a.prototype.getEdges=function(e,t,i){var s=r.getTiddler(e);if(!s||r.isSystemOrDraft(s))return;var o=r.getDataMap();this._addTmapEdges(o,s,t,i);this._addBodyAndFieldEdges(o,s,t,i);return o};a.prototype._addBodyAndFieldEdges=function(e,t,i,s){var o=t.fields;var a=r.getTiddlerRef(t);var n=this.indeces;var d=n.fiETy;var l=n.liETy;var p=n.maETyFiNa;var g=r.getDataMap();if(!s||s["tw-body:link"]){g["tw-body:link"]=$tw.wiki.getTiddlerLinks(a)}for(var f in o){if(!p[f])continue;var c=d["tw-field:"+f]||l["tw-list:"+f];if(s&&!s[c.id])continue;if(d[c.id]){g[c.id]=[o[f]]}else if(l[c.id]){g[c.id]=$tw.utils.parseStringArray(o[f])}}if(!g)return;var v=t.fields["tmap.id"];var u=n.idByT;var h=n.allETy;for(var y in g){var w=g[y];if(!w)continue;var c=h[y];for(var m=w.length;m--;){var b=w[m];if(!b||!$tw.wiki.tiddlerExists(b)||r.isSystemOrDraft(b)||i&&!i[b])continue;var T=c.id+$tw.utils.hashString(a+b);var E=this.makeEdge(v,u[b],c,T);if(E){e[E.id]=E}}}};a.prototype._addTmapEdges=function(e,t,i,s){var o=r.parseFieldData(t,"tmap.edges");if(!o)return;var a=this.indeces.tById;var n=t.fields["tmap.id"];for(var d in o){var l=o[d];var p=a[l.to];if(p&&(!i||i[p])&&(!s||s[l.type])){var g=this.makeEdge(n,l.to,l.type,d);if(g){e[d]=g}}}};a.prototype.getEdgeTypeWhiteList=function(e){var i=r.getDataMap();var s=r.getMatches(this.opt.selector.allEdgeTypes);var o=e?r.getMatches(e,s):s;for(var a=o.length;a--;){var n=new t(o[a]);i[n.id]=true}return i};a.prototype.getEdgesForSet=function(e,t,i){var s=r.getDataMap();for(var o=e.length;o--;){$tw.utils.extend(s,this.getEdges(e[o],t,i))}return s};a.prototype.selectEdgesByType=function(e){var i=r.getDataMap();i[new t(e).id]=true;return this.getEdgesForSet(this.getAllPotentialNodes(),null,i)};a.prototype.getAllPotentialNodes=function(){return r.getMatches(this.opt.selector.allPotentialNodes)};a.prototype._processEdgesWithType=function(e,i){e=new t(e);this.logger("debug","Processing edges",e,i);var r=this.selectEdgesByType(e);if(i.action==="rename"){var s=new t(i.newName);s.load(e);s.save()}for(var o in r){this._processEdge(r[o],"delete");if(i.action==="rename"){r[o].type=i.newName;this._processEdge(r[o],"insert")}}$tw.wiki.deleteTiddler(e.fullPath)};a.prototype.selectNodesByFilter=function(e,t){var i=r.getMatches(e);return this.selectNodesByReferences(i,t)};a.prototype.selectNodesByReferences=function(e,t){t=t||{};var i=t.addProperties;var s=r.getDataMap();var o=Object.keys(e);for(var a=o.length;a--;){var n=this.makeNode(e[o[a]],i);if(n){s[n.id]=n}}return r.convert(s,t.outputType)};a.prototype.selectNodesByIds=function(e,t){var i=this.getTiddlersById(e);return this.selectNodesByReferences(i,t)};a.prototype.selectNodeById=function(e,t){t=r.merge(t,{outputType:"hashmap"});var i=this.selectNodesByIds([e],t);return i[e]};a.prototype.makeEdge=function(e,i,s,o){if(!e||!i)return;if(e instanceof $tw.Tiddler){e=e.fields["tmap.id"]}else if(typeof e==="object"){e=e.id}s=this.indeces.allETy[s]||new t(s);var a=s.getLabel();var n={id:o||r.genUUID(),from:e,to:i,type:s.id};var d=s.description;n.title=d||a||n.id;if(r.isTrue(s["show-label"],true)){n.label=a}n=$tw.utils.extend(n,s.style);return n};a.prototype.removeNodeType=function(e){var e=new i(e);$tw.wiki.deleteTiddler(e.fullPath)};a.prototype.makeNode=function(e,t){var i=r.getTiddler(e);if(!i||i.isDraft()||$tw.wiki.isSystemTiddler(i.fields.title)){return}var s=r.merge({},t);s.id=this.assignId(i);var o=i.fields[this.opt.field.nodeLabel];s.label=o&&this.opt.field.nodeLabel!=="title"?$tw.wiki.renderText("text/plain","text/vnd-tiddlywiki",o):i.fields.title;return s};a.prototype.getInheritedNodeStyles=function(t,i){i=i?new e(i).getLabel():null;var s=this.getTiddlersById(t);var o={};var a=this.indeces.glNTy;for(var n=a.length;n--;){var d=a[n];if(d.id==="tmap:neighbour"){var l=$tw.tmap.indeces.tById;var p=[];for(var g in t){if(t[g].group==="tmap:neighbour"){p.push(l[g])}}}else{var p=d.getInheritors(s)}for(var f=p.length;f--;){var c=p[f];var v=o[c]=o[c]||{};v.style=r.merge(v.style||{},d.style);if(d["fa-icon"]){v["fa-icon"]=d["fa-icon"]}else if(d["tw-icon"]){v["tw-icon"]=d["tw-icon"]}}}return o};a.prototype.attachStylesToEdges=function(e,t){};a.prototype._removeObsoleteViewData=function(t,i){i=new e(i);if(!i.exists()||!t)return;var r=i.getNodeData();var s=0;for(var o in r){if(t[o]===undefined&&r[o]!=null){r[o]=undefined;s++}}if(s){this.logger("debug","[Cleanup]","Removed obsolete node data:",i.getLabel(),s);i.saveNodeData(r)}};a.prototype.attachStylesToNodes=function(t,i){i=new e(i);var o=this.getInheritedNodeStyles(t,i);var a=i.getNodeData();var n=!i.isEnabled("physics_mode");var d=this.opt.field.nodeInfo;var l=this.opt.field.nodeIcon;var p=this.indeces.tById;for(var g in t){var f=p[g];var c=$tw.wiki.getTiddler(f);var v=c.fields;var u=t[g];var h=null;var y=null;if(o[f]){if(o[f].style){r.merge(u,o[f].style)}h=o[f]["fa-icon"];y=o[f]["tw-icon"]}if(v.color){u.color=v.color}if(v["tmap.style"]){r.merge(u,r.parseJSON(v["tmap.style"]))}h=v["tmap.fa-icon"]||h;y=v["icon"]||y;if(a[g]){r.merge(u,a[g]);if(n){u.fixed={x:u.x!=null,y:u.y!=null}}h=a[g]["fa-icon"]||h;y=a[g]["tw-icon"]||y}var w=u.color!==null&&typeof u.color==="object";var m=w?u.color.background:u.color;u.color={background:m,border:w?u.color.border:undefined};this._addNodeIcon(u,h,y);u.font=u.font||{};if(u.shape&&!this.visShapesWithTextInside[u.shape]){u.font.color="black"}else if(!u.font.color&&m){u.font.color=s(m,m,"black","white")}if(u.shape==="icon"&&typeof u.icon==="object"){u.icon.color=m}if(v[d]){u.title=$tw.wiki.renderText("text/html","text/vnd-tiddlywiki",v[d])}else if(u.label!==f){u.title=f}}};a.prototype.deleteNode=function(t){if(!t)return;var i=typeof t==="object"?t.id:t;var s=this.indeces.tById[i];if(s){r.deleteTiddlers([s])}var o=$tw.tmap.opt.selector.allViews;var a=r.getMatches(o);for(var n=a.length;n--;){var d=new e(a[n]);d.removeNodeFromFilter(i);if(d.getNodeData(i)){d.saveNodeData(i,null)}}var l=this.getNeighbours([s]);this.deleteEdges(l.edges)};a.prototype.deleteNodes=function(e){e=r.convert(e,"array");for(var t=e.length;t--;){this.deleteNode(e[t])}};a.prototype.getView=function(t,i){return new e(t,i)};a.prototype.createView=function(t){return new e(t,true)};a.prototype.storePositions=function(t,i){i=new e(i);i.saveNodeData(t)};a.prototype.assignId=function(e,t){var i=r.getTiddler(e,true);if(!i)return;var s=i.fields["tmap.id"];if(!s||t){s=r.genUUID();r.setField(i,"tmap.id",s);this.logger("info","Assigning new id to",i.fields.title)}this.indeces.tById[s]=i.fields.title;this.indeces.idByT[i.fields.title]=s;return s};a.prototype.insertNode=function(t,i,r){r=r||{};t=t||{};var s={"tmap.id":null};if(!r.fields||!r.fields.text){s.text=""}var o=$tw.wiki.generateNewTitle(t.label||"New node");t.label=s.title=o;var a=new $tw.Tiddler(r.fields,s,$tw.wiki.getModificationFields(),$tw.wiki.getCreationFields());$tw.wiki.addTiddler(a);t=this.makeNode(a,t);var i=new e(i);i.addNodeToView(t);return t};a.prototype._getFAdigits=function(e){return e.length===4?e:e.substr(3,4)};a.prototype.getTiddlersById=function(e){if(Array.isArray(e)){e=r.getArrayValuesAsHashmapKeys(e)}else if(e instanceof o.DataSet){e=r.getLookupTable(e,"id")}var t=[];var i=this.indeces.tById;for(var s in e){if(i[s])t.push(i[s])}return t};a.prototype.getId=function(e){return this.indeces.idByT[r.getTiddlerRef(e)]};a.prototype._addNodeIcon=function(e,t,i){if(t){e.shape="icon";e.icon={shape:"icon",face:"FontAwesome",color:e.color,code:String.fromCharCode("0x"+this._getFAdigits(t))};return}if(!i)return;var s=r.getTiddler(i);if(!s)return;if(s.fields["_canonical_uri"]){e.image=s.fields["_canonical_uri"];e.shape="image";return}if(s.fields.text){var o=s.fields.type||"image/svg+xml";var a=s.fields.text;if(o==="image/svg+xml"){a=a.replace(/\r?\n|\r/g," ");if(!r.inArray("xmlns",a)){a=a.replace(/<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')}}var n=$tw.config.contentTypeInfo[o].encoding==="base64"?a:window.btoa(a);e.image="data:"+o+";base64,"+n;e.shape="image";return}};exports.Adapter=a})();