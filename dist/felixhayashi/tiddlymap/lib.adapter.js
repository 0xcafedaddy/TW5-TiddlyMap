/*\

title: $:/plugins/felixhayashi/tiddlymap/js/Adapter
type: application/javascript
module-type: library

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var e=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction").ViewAbstraction;var t=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var i=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType").NodeType;var r=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var o=require("$:/core/modules/macros/contrastcolour.js").run;var s=require("$:/plugins/felixhayashi/vis/vis.js");var a=function(){this.opt=$tw.tmap.opt;this.logger=$tw.tmap.logger;this.visShapesWithTextInside=r.getLookupTable(["ellipse","circle","database","box","text"])};a.prototype.deleteEdge=function(e){return this._processEdge(e,"delete")};a.prototype.deleteEdges=function(e){e=r.convert(e,"array");for(var t=e.length;t--;){this.deleteEdge(e[t])}};a.prototype.insertEdge=function(e){return this._processEdge(e,"insert")};a.prototype._processEdge=function(e,i){this.logger("debug","Edge",i,e);if(typeof e!=="object"||!i||!e.from)return;if(i==="insert"&&!e.to)return;var o=$tw.tmap.indeces.tById[e.from];if(!o||!r.tiddlerExists(o))return;var s=new t(e.type);var a=r.getTiddler(o);var n=s.getNamespace();if(n==="tw-list"){if(!e.to)return;return this._processListEdge(a,e,s,i)}else if(n==="tw-field"){if(!e.to)return;return this._processFieldEdge(a,e,s,i)}else if(n==="tw-body"){return null}else{return this._processTmapEdge(a,e,s,i)}return e};a.prototype._processTmapEdge=function(e,t,i,o){if(o==="delete"&&!t.id)return;var s=r.parseFieldData(e,"tmap.edges",{});if(o==="insert"){t.id=t.id||r.genUUID();s[t.id]={to:t.to,type:i.getId()};if(!i.exists()){i.persist()}}else{delete s[t.id]}r.writeFieldData(e,"tmap.edges",s);return t};a.prototype._processListEdge=function(e,t,i,o){var s=i.getId(true);var a=r.getTiddler(e);var n=$tw.utils.parseStringArray(e.fields[s]);n=(n||[]).slice();var d=$tw.tmap.indeces.tById[t.to];if(o==="insert"){n.push(d);if(!i.exists()){i.persist()}}else{var l=n.indexOf(d);if(l>-1){n.splice(l,1)}}r.setField(a,s,$tw.utils.stringifyList(n));return t};a.prototype._processFieldEdge=function(e,t,i,o){var s=$tw.tmap.indeces.tById[t.to];if(s==null)return;var a=o==="insert"?s:"";r.setField(e,i.getId(true),a);if(!i.exists()){i.persist()}return t};a.prototype.getAdjacencyList=function(e,t){$tw.tmap.start("Creating adjacency list");t=t||{};if(!t.edges){var i=r.getMatches(this.opt.selector.allPotentialNodes);t.edges=this.getEdgesForSet(i,t.toWL,t.typeWL)}var o=r.groupByProperty(t.edges,e);$tw.tmap.stop("Creating adjacency list");return o};a.prototype.getNeighbours=function(e,t){$tw.tmap.start("Get neighbours");t=t||{};e=e.slice();var i=t.addProperties;var o=this.getAdjacencyList("to",t);var s=r.getDataMap();var a=r.getDataMap();var n=parseInt(t.steps)>0?t.steps:1;var d=function(){var n=r.getArrayValuesAsHashmapKeys(e);for(var d=e.length;d--;){if(r.isSystemOrDraft(e[d]))continue;var l=this.getEdges(e[d],t.toWL,t.typeWL);$tw.utils.extend(s,l);for(var p in l){var g=$tw.tmap.indeces.tById[l[p].to];if(!n[g]&&!a[l[p].to]){var f=this.makeNode(g,i);if(f){a[l[p].to]=f;e.push(g)}}}var c=o[$tw.tmap.indeces.idByT[e[d]]];if(c){for(var u=0;u<c.length;u++){var v=$tw.tmap.indeces.tById[c[u].from];if(n[v])continue;if(!a[c[u].from]){var f=this.makeNode(v,i);if(f){a[c[u].from]=f;e.push(v)}}s[c[u].id]=c[u]}}}}.bind(this);for(var l=0;l<n;l++){var p=e.length;d();if(p===e.length)break}var g={nodes:a,edges:s};this.logger("debug","Retrieved neighbourhood",g,"steps",l);$tw.tmap.stop("Get neighbours");return g};a.prototype.getGraph=function(t){$tw.tmap.start("Assembling Graph");t=t||{};var i=new e(t.view);var o=r.getMatches(t.filter||i.getNodeFilter("compiled"));var s=r.getArrayValuesAsHashmapKeys(o);var a=this.getEdgeTypeWhiteList(i.getEdgeFilter("compiled"));var n=parseInt(t.neighbourhoodScope||i.getConfig("neighbourhood_scope"));var d={edges:this.getEdgesForSet(o,s,a),nodes:this.selectNodesByReferences(o,{view:i,outputType:"hashmap"})};if(n){var l=this.getNeighbours(o,{steps:n,view:i,typeWL:a,addProperties:{group:"tmap:neighbour"}});r.merge(d,l);if(i.isEnabled("show_inter_neighbour_edges")){var p=this.getTiddlersById(l.nodes);var s=r.getArrayValuesAsHashmapKeys(p);$tw.utils.extend(d.edges,this.getEdgesForSet(p,s))}}this._removeObsoleteViewData(d.nodes,i);this.attachStylesToNodes(d.nodes,i);$tw.tmap.stop("Assembling Graph");this.logger("debug","Assembled graph:",d);return d};a.prototype.getEdges=function(e,t,i){if(!r.tiddlerExists(e)||r.isSystemOrDraft(e)){return}var o=r.getTiddler(e);var s=r.getTiddlerRef(e);var a=this._getTmapEdges(e,t,i);var n=r.getMatches($tw.tmap.opt.selector.allListEdgeStores);var d=r.getDataMap();d["tw-body:link"]=$tw.wiki.getTiddlerLinks(s);for(var l=n.length;l--;){d["tw-list:"+n[l]]=$tw.utils.parseStringArray(o.fields[n[l]])}var n=r.getMatches($tw.tmap.opt.selector.allFieldEdgeStores);for(var l=n.length;l--;){d["tw-field:"+n[l]]=[o.fields[n[l]]]}$tw.utils.extend(a,this._getEdgesFromRefArray(s,d,t,i));return a};a.prototype._getEdgesFromRefArray=function(e,i,o,s){var a=r.getDataMap();for(var n in i){var d=i[n];if(!d||s&&!s[n])continue;n=new t(n);for(var l=d.length;l--;){var p=d[l];if(!p||!$tw.wiki.tiddlerExists(p)||r.isSystemOrDraft(p)||o&&!o[p])continue;var g=n.getId()+$tw.utils.hashString(e+p);var f=this.makeEdge(this.getId(e),this.getId(p),n,g);if(f){a[f.id]=f}}}return a};a.prototype._getTmapEdges=function(e,t,i){var o=r.parseFieldData(e,"tmap.edges",{});var s=r.getDataMap();for(var a in o){var n=o[a];var d=$tw.tmap.indeces.tById[n.to];if(d&&(!t||t[d])&&(!i||i[n.type])){var l=this.makeEdge(this.getId(e),n.to,n.type,a);if(l){s[a]=l}}}return s};a.prototype.getEdgeTypeWhiteList=function(e){var i=r.getDataMap();var o=r.getMatches(this.opt.selector.allEdgeTypes);var s=e?r.getMatches(e,o):o;for(var a=s.length;a--;){var n=new t(s[a]);i[n.getId()]=n}return i};a.prototype.getEdgesForSet=function(e,t,i){var o=r.getDataMap();for(var s=e.length;s--;){$tw.utils.extend(o,this.getEdges(e[s],t,i))}return o};a.prototype.selectEdgesByType=function(e){var i=r.getDataMap();i[new t(e).getId()]=true;var o=r.getMatches(this.opt.selector.allPotentialNodes);var s=this.getEdgesForSet(o,null,i);return s};a.prototype._processEdgesWithType=function(e,i){e=new t(e);this.logger("debug","Processing edges",e,i);var r=this.selectEdgesByType(e);if(i.action==="rename"){var o=new t(i.newName);o.loadDataFromType(e);o.persist()}for(var s in r){this._processEdge(r[s],"delete");if(i.action==="rename"){r[s].type=i.newName;this._processEdge(r[s],"insert")}}$tw.wiki.deleteTiddler(e.getPath())};a.prototype.selectNodesByFilter=function(e,t){var i=r.getMatches(e);return this.selectNodesByReferences(i,t)};a.prototype.selectNodesByReferences=function(e,t){t=t||{};var i=t.addProperties;var o=r.getDataMap();var s=Object.keys(e);for(var a=s.length;a--;){var n=this.makeNode(e[s[a]],i);if(n){o[n.id]=n}}return r.convert(o,t.outputType)};a.prototype.selectNodesByIds=function(e,t){var i=this.getTiddlersById(e);return this.selectNodesByReferences(i,t)};a.prototype.selectNodeById=function(e,t){t=r.merge(t,{outputType:"hashmap"});var i=this.selectNodesByIds([e],t);return i[e]};a.prototype.makeEdge=function(e,i,o,s){if(!e||!i)return;if(e instanceof $tw.Tiddler){e=e.fields[this.opt.field.nodeId]}else if(typeof e==="object"){e=e.id}o=new t(o);var a={id:s||r.genUUID(),from:e,to:i,type:o.getId(),title:o.getData("description")||undefined};a.label=r.isTrue(o.getData("show-label"),true)?o.getLabel():undefined;a=$tw.utils.extend(a,o.getData("style"));return a};a.prototype.removeNodeType=function(e){$tw.wiki.deleteTiddler(new i(e).getPath())};a.prototype.makeNode=function(e,t){var i=r.getTiddler(e);if(!i||i.isDraft()||$tw.wiki.isSystemTiddler(i.fields.title)){return}var o=r.merge({},t);o.id=this.assignId(i);var s=i.fields[this.opt.field.nodeLabel];o.label=s&&this.opt.field.nodeLabel!=="title"?$tw.wiki.renderText("text/plain","text/vnd-tiddlywiki",s):i.fields.title;return o};a.prototype.getInheritedNodeStyles=function(t,i){i=i?new e(i).getLabel():null;var o=this.getTiddlersById(t);var s={};var a=$tw.tmap.indeces.loGlNTy;for(var n=a.length;n--;){var d=a[n].data;if(i&&d.view&&d.view!==i)continue;var l=a[n].getInheritors(o);if(!l.length)continue;for(var p=l.length;p--;){var g=l[p];s[g]=s[g]||{};s[g].style=r.merge(s[g].style||{},d.style);if(d["fa-icon"]){s[g]["fa-icon"]=d["fa-icon"]}else if(d["tw-icon"]){s[g]["tw-icon"]=d["tw-icon"]}}}return s};a.prototype.attachStylesToEdges=function(e,t){};a.prototype._removeObsoleteViewData=function(t,i){i=new e(i);if(!i.exists()||!t)return;var r=i.getNodeData();var o=0;for(var s in r){if(t[s]===undefined){delete r[s];o++}}if(o){this.logger("debug","Removed "+o+" node data records from view "+i.getLabel());i.saveNodeData(r)}};a.prototype.attachStylesToNodes=function(t,s){s=new e(s);var a=this.getInheritedNodeStyles(t,s);var n=new i("tmap:neighbour").getData("style");var d=s.exists()?s.getNodeData():{};var l=!s.isEnabled("physics_mode");for(var p in t){var g=$tw.tmap.indeces.tById[p];var f=$tw.wiki.getTiddler(g);var c=f.fields;var u=t[p];if(a[g]){if(a[g].style){r.merge(u,a[g].style)}this._addNodeIcon(u,a[g]["fa-icon"],a[g]["tw-icon"])}if(u.group==="tmap:neighbour"){r.merge(u,n);delete u.group}if(c.color){u.color=c.color}if(c["tmap.style"]){r.merge(u,r.parseJSON(c["tmap.style"]))}this._addNodeIcon(u,c["tmap.fa-icon"],c[this.opt.field.nodeIcon]);if(d[p]){r.merge(u,d[p]);if(l){u.fixed={x:true,y:true}}}u.color=typeof u.color==="object"?u.color.background:u.color;u.font=u.font||{};if(typeof u.font==="object"&&!u.font.color){var v=u.shape;if(v&&!this.visShapesWithTextInside[v]){u.font.color="black"}else{if(u.color){u.font.color=o(u.color,u.color,"black","white")}}}if(u.shape==="icon"&&typeof u.icon==="object"){u.icon.color=u.color}var h=c[this.opt.field.nodeInfo];if(h&&this.opt.field.nodeInfo!=="text"){u.title=$tw.wiki.renderText("text/html","text/vnd-tiddlywiki",h)}else if(u.label!==g){u.title=g}}};a.prototype.deleteNode=function(t){if(!t)return;var i=typeof t==="object"?t.id:t;var o=$tw.tmap.indeces.tById[i];if(o){r.deleteTiddlers([o])}var s=$tw.tmap.opt.selector.allViews;var a=r.getMatches(s);for(var n=0;n<a.length;n++){var d=new e(a[n]);if(d.getNodeData(i)){d.saveNodeData(i,null)}}var l=this.getNeighbours([o]);this.deleteEdges(l.edges)};a.prototype.getView=function(t,i){return new e(t,i)};a.prototype.createView=function(t){if(typeof t!=="string"||t===""){t="My view"}var i=$tw.wiki.generateNewTitle(this.opt.path.views+"/"+t);return new e(i,true)};a.prototype.createType=function(e,r){r=r||"me:new-type";var o=e==="edge"?this.opt.path.edgeTypes:this.opt.path.nodeTypes;var s=$tw.wiki.generateNewTitle(o+"/"+r);var e=e==="edge"?new t(s):new i(s);e.persist();return e};a.prototype.storePositions=function(t,i){i=new e(i);i.saveNodeData(t)};a.prototype.assignId=function(e,t){var i=r.getTiddler(e,true);if(!i)return;var o=this.opt.field.nodeId;var s=i.fields[o];if(!s||t&&o!=="title"){s=r.genUUID();r.setField(i,o,s);this.logger("info","Assigning new id to",i.fields.title)}$tw.tmap.indeces.tById[s]=i.fields.title;$tw.tmap.indeces.idByT[i.fields.title]=s;return s};a.prototype.insertNode=function(t,i){if(!i||typeof i!=="object")i={};if(!t||typeof t!=="object"){t=r.getDataMap()}var o=r.getDataMap();o.title=$tw.wiki.generateNewTitle(t.label?t.label:"New node");t.label=o.title;if(this.opt.field.nodeId==="title"){t.id=o.title}else{t.id=r.genUUID();o[this.opt.field.nodeId]=t.id}if(i.view){var s=new e(i.view);s.addNodeToView(t)}$tw.wiki.addTiddler(new $tw.Tiddler(o,$tw.wiki.getModificationFields(),$tw.wiki.getCreationFields()));return t};a.prototype.getTiddlersById=function(e){if(Array.isArray(e)){e=r.getArrayValuesAsHashmapKeys(e)}else if(e instanceof s.DataSet){e=r.getLookupTable(e,"id")}var t=[];var i=$tw.tmap.indeces.tById;for(var o in e){if(i[o])t.push(i[o])}return t};a.prototype.getId=function(e){return $tw.tmap.indeces.idByT[r.getTiddlerRef(e)]};a.prototype._addNodeIcon=function(e,t,i){if(t){e.shape="icon";e.icon={shape:"icon",face:"FontAwesome",color:e.color,code:String.fromCharCode("0x"+t)};return}if(!i)return;var o=r.getTiddler(i);if(o&&o.fields.text){var s=o.fields.type||"image/svg+xml";var a=o.fields.text;e.shape="image";if(s==="image/svg+xml"){a=a.replace(/\r?\n|\r/g," ");if(!r.inArray("xmlns",a)){a=a.replace(/<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')}}var n=$tw.config.contentTypeInfo[s].encoding==="base64"?a:window.btoa(a);e.image="data:"+s+";base64,"+n}};exports.Adapter=a})();