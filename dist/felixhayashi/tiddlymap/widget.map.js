/*\

title: $:/plugins/felixhayashi/tiddlymap/js/widget/MapWidget
type: application/javascript
module-type: widget

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var e=require("$:/core/modules/widgets/widget.js").widget;var t=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var i=require("$:/plugins/felixhayashi/tiddlymap/js/DialogManager").DialogManager;var s=require("$:/plugins/felixhayashi/tiddlymap/js/CallbackManager").CallbackManager;var r=require("$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction").ViewAbstraction;var a=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType").EdgeType;var n=require("$:/plugins/felixhayashi/tiddlymap/js/NodeType").NodeType;var o=require("$:/plugins/felixhayashi/vis/vis.js");var d=function(r,a){e.call(this,r,a);this.adapter=$tw.tmap.adapter;this.opt=$tw.tmap.opt;this.indeces=$tw.tmap.indeces;this.notify=$tw.tmap.notify;this.fsapi=t.getFullScreenApis();this.getAttr=this.getAttribute;this.isDebug=t.isTrue(this.opt.config.sys.debug,false);this.callbackManager=new s;this.dialogManager=new i(this.callbackManager,this);this.computeAttributes();this.editorMode=this.getAttr("editor");this.clickToUse=t.isTrue(this.getAttr("click-to-use"),true);this.objectId=this.getAttr("object-id")||t.genUUID();if(this.editorMode){t.addListeners({"tmap:tm-create-view":this.handleCreateView,"tmap:tm-rename-view":this.handleRenameView,"tmap:tm-delete-view":this.handleDeleteView,"tmap:tm-edit-view":this.handleEditView,"tmap:tm-store-position":this.handleStorePositions,"tmap:tm-edit-filters":this.handleEditFilters,"tmap:tm-generate-widget":this.handleGenerateWidget,"tmap:tm-save-canvas":this.handleSaveCanvas},this,this)}t.addListeners({"tmap:tm-focus-node":this.handleFocusNode,"tmap:tm-reset-focus":this.repaintGraph},this,this);this.visHandlers={click:this.handleVisSingleClickEvent,doubleClick:this.handleVisDoubleClickEvent,stabilized:this.handleVisStabilizedEvent,dragStart:this.handleVisDragStart,selectNode:this.handleVisSelectNode,deselectNode:this.handleVisDeselectNode,dragEnd:this.handleVisDragEnd,oncontext:this.handleVisOnContext,beforeDrawing:this.handleVisBeforeDrawing,showPopup:this.handleVisShowPopup,stabilizationProgress:this.handleVisLoading,stabilizationIterationsDone:this.handleVisLoadingDone}};d.prototype=Object.create(e.prototype);d.prototype.handleConnectionEvent=function(e,i){var s={fromLabel:this.adapter.selectNodeById(e.from).label,toLabel:this.adapter.selectNodeById(e.to).label};var r="getEdgeType";this.dialogManager.open(r,s,function(s,r){if(s){var n=t.getText(r);var o=this.view.getConfig("edge_type_namespace");var d=t.hasSubString(n,":");n=new a((o&&!d?o:"")+n);if(!n.exists()){n.save();this.rebuildEdgeTypeWL()}e.type=n.id;var h=this.adapter.insertEdge(e);if(!this.edgeTypeWL[n.id]){var l={type:n.id,view:this.view.getLabel()};$tw.tmap.dialogManager.open("edgeNotVisible",l)}this.preventFitAfterRebuild=true}if(typeof i==="function"){i(s)}})};d.prototype.checkForFreshInstall=function(){var e=this.opt.ref.sysMeta;if(!t.getEntry(e,"showWelcomeMessage",true))return;t.setEntry(e,"showWelcomeMessage",false);var i={};var s="welcome";this.dialogManager.open(s,i,function(e,i){if(t.tiddlerExists("$:/plugins/felixhayashi/topstoryview")){t.setText("$:/view","top");t.setText("$:/config/Navigation/openLinkFromInsideRiver","above");t.setText("$:/config/Navigation/openLinkFromOutsideRiver","top");t.touch("$:/plugins/felixhayashi/topstoryview")}var s={view:this.opt.misc.defaultViewLabel};var r=this.adapter.insertNode({label:"Have fun with",x:0,y:0},s);var a=this.adapter.insertNode({label:"TiddlyMap!!",x:100,y:100},s);this.adapter.insertEdge({from:r.id,to:a.id})})};d.prototype.openStandardConfirmDialog=function(e,t){var i={message:t};this.dialogManager.open("getConfirmation",i,e)};d.prototype.logger=function(e,t){if(this.isDebug){var i=Array.prototype.slice.call(arguments,1);i.unshift("@"+this.objectId.toUpperCase());i.unshift(e);$tw.tmap.logger.apply(this,i)}};d.prototype.render=function(e,i){this.parentDomNode=e;this.domNode=this.document.createElement("div");e.insertBefore(this.domNode,i);this.domNode.style["width"]=this.getAttr("width","100%");this.registerClassNames(this.domNode);this.viewHolderRef=this.getViewHolderRef();this.view=this.getView();this.graphBarDomNode=this.document.createElement("div");$tw.utils.addClass(this.graphBarDomNode,"tmap-topbar");this.domNode.appendChild(this.graphBarDomNode);this.graphDomNode=this.document.createElement("div");this.domNode.appendChild(this.graphDomNode);$tw.utils.addClass(this.graphDomNode,"tmap-vis-graph");if(t.isPreviewed(this)||this.domNode.isTiddlyWikiFakeDom){$tw.utils.addClass(this.domNode,"tmap-static-mode");this.renderPreview(this.graphBarDomNode,this.graphDomNode)}else{this.addLoadingBar(this.domNode);this.renderFullWidget(this.graphBarDomNode,this.graphDomNode)}};d.prototype.renderPreview=function(e,i){var s=this.view.getRoot()+"/snapshot";var r=t.getTiddler(s);var a=this.document.createElement("span");a.innerHTML=this.view.getLabel();a.className="tmap-view-label";e.appendChild(a);if(r){this.makeChildWidgets([{type:"transclude",attributes:{tiddler:{type:"string",value:s}}}]);this.renderChildren(i,null)}else{$tw.utils.addClass(i,"tmap-graph-placeholder")}};d.prototype.renderFullWidget=function(e,i){this.sidebar=t.getFirstElementByClassName("tc-sidebar-scrollable");this.isContainedInSidebar=this.sidebar&&!this.domNode.isTiddlyWikiFakeDom&&this.sidebar.contains(this.domNode);this.doFitAfterStabilize=true;this.preventFitAfterRebuild=false;this.initAndRenderEditorBar(e);this.initAndRenderGraph(i);$tw.tmap.registry.push(this);this.reloadRefreshTriggers();this.checkForFreshInstall()};d.prototype.registerClassNames=function(e){var i=$tw.utils.addClass;i(e,"tmap-widget");if(this.clickToUse){i(e,"tmap-click-to-use")}if(this.getAttr("editor")==="advanced"){i(e,"tmap-advanced-editor")}if(this.getAttr("design")==="plain"){i(e,"tmap-plain-design")}if(!t.isTrue(this.getAttr("show-buttons"),true)){i(e,"tmap-no-buttons")}if(this.getAttr("class")){i(e,this.getAttr("class"))}};d.prototype.addLoadingBar=function(e){this.graphLoadingBarDomNode=this.document.createElement("div");$tw.utils.addClass(this.graphLoadingBarDomNode,"tmap-loading-bar");e.appendChild(this.graphLoadingBarDomNode)};d.prototype.initAndRenderEditorBar=function(e){this.rebuildEditorBar()};d.prototype.rebuildEditorBar=function(){var e=this.view;var t={isViewBound:String(this.isViewBound()),viewRoot:e.getRoot(),viewLabel:e.getLabel(),viewHolder:this.getViewHolderRef(),edgeFilter:e.getPaths().edgeFilter,allEdgesFilter:this.opt.selector.allEdgeTypes,neighScopeBtnClass:"tmap-neigh-scope-button"+(e.isEnabled("neighbourhood_scope")?" "+"tmap-active-button":"")};for(var i in t){this.setVariable(i,t[i])}var s={type:"tiddler",attributes:{tiddler:{type:"string",value:e.getRoot()}},children:[]};if(this.editorMode==="advanced"){s.children.push({type:"transclude",attributes:{tiddler:{type:"string",value:this.opt.ref.graphBar}}})}else{s.children.push({type:"element",tag:"span",attributes:{"class":{type:"string",value:"tmap-view-label"}},children:[{type:"text",text:e.getLabel()}]})}s.children.push({type:"transclude",attributes:{tiddler:{type:"string",value:this.opt.ref.focusButton}}});this.makeChildWidgets([s]);this.renderChildren(this.graphBarDomNode,this.graphBarDomNode.firstChild)};d.prototype.refresh=function(e){if(!this.network||this.isZombieWidget()||t.isPreviewed(this)){return}var i=false;var s=false;var r={};this.callbackManager.handleChanges(e);if(this.isViewSwitched(e)){i=true;s=true;r.resetData=true;r.resetOptions=true;r.resetEdgeTypeWL=true;r.resetFocus={delay:0,duration:0};this.logger("warn","View switched");this.view=this.getView(true);this.reloadRefreshTriggers();this.visNetworkDomNode.focus()}else{var a=this.view.refresh(e);if(a.length&&!this.ignoreNextViewModification){this.logger("warn","View modified",a);i=true;s=true;r.resetOptions=true;r.resetEdgeTypeWL=true;if(!this.preventFitAfterRebuild){r.resetFocus={delay:0,duration:0}}}else{if(this.hasChangedGlobals(e)){s=true;r.resetOptions=true}if(this.hasChangedEdgeTypes(e)){s=true;r.resetEdgeTypeWL=true}if(!s&&this.hasChangedNodeTypes(e)){s=true}if(!s&&this.hasChangedElements(e)){s=true}}}if(s){this.rebuildGraph(r)}if(i){this.removeChildDomNodes();this.rebuildEditorBar()}else{this.refreshChildren(e)}this.ignoreNextViewModification=false};d.prototype.reloadRefreshTriggers=function(){this.callbackManager.remove(this.refreshTriggers);var e=this.getAttr("refresh-triggers")||this.view.getConfig("refresh-triggers");this.refreshTriggers=$tw.utils.parseStringArray(e)||[];this.logger("debug","Registering refresh trigger",this.refreshTriggers);var t=this.handleTriggeredRefresh.bind(this);for(var i=this.refreshTriggers.length;i--;){this.callbackManager.add(this.refreshTriggers[i],t,false)}};d.prototype.rebuildGraph=function(e){if(t.isPreviewed(this))return;this.logger("debug","Rebuilding graph");e=e||{};this.hasNetworkStabilized=false;if(e.resetData){this.graphData.edges.clear();this.graphData.nodes.clear();this.graphData.edgesById=null;this.graphData.nodesById=null}if(e.resetOptions){this.reloadOptions()}if(!this.view.isEnabled("physics_mode")){var i=this.graphOptions.physics;i[i.solver].centralGravity=.015}if(!e.resetFocus){this.doFitAfterStabilize=false}this.network.setOptions(this.graphOptions);this.rebuildGraphData({resetEdgeTypeWL:e.resetEdgeTypeWL});if(!t.hasElements(this.graphData.nodesById)){return}this.network.stabilize();if(e.resetFocus&&!this.preventFitAfterRebuild){this.doFitAfterStabilize=true;this.fitGraph(e.resetFocus.delay,e.resetFocus.duration)}this.preventFitAfterRebuild=false};d.prototype.getContainer=function(){return this.domNode};d.prototype.reloadOptions=function(){this.network.setOptions({nodes:undefined,edges:undefined,interaction:undefined,layout:undefined,manipulation:undefined,physics:undefined});this.graphOptions=this.getGraphOptions();this.network.setOptions(this.graphOptions)};d.prototype.rebuildGraphData=function(e){$tw.tmap.start("Reloading Network");e=e||{};if(!this.edgeTypeWL||e.resetEdgeTypeWL){this.rebuildEdgeTypeWL()}var i=this.adapter.getGraph({view:this.view,edgeTypeWL:this.edgeTypeWL});var s=i.nodes;var r=i.edges;this.graphData.nodes=this.getRefreshedDataSet(s,this.graphData.nodesById,this.graphData.nodes);this.graphData.edges=this.getRefreshedDataSet(r,this.graphData.edgesById,this.graphData.edges);this.graphData.nodesById=s;this.graphData.edgesById=r;t.setField("$:/temp/tmap/nodes/"+this.view.getLabel(),"list",this.adapter.getTiddlersById(s));$tw.tmap.stop("Reloading Network");return this.graphData};d.prototype.rebuildEdgeTypeWL=function(){var e=this.view.getEdgeFilter("compiled");this.edgeTypeWL=this.adapter.getEdgeTypeWhiteList(e);return this.edgeTypeWL};d.prototype.isViewBound=function(){return t.startsWith(this.getViewHolderRef(),this.opt.path.localHolders)};d.prototype.isViewSwitched=function(e){return e[this.getViewHolderRef()]&&!this.isViewBound()};d.prototype.hasChangedNodeTypes=function(e){return t.hasPropWithPrefix(e,this.opt.path.nodeTypes)};d.prototype.hasChangedGlobals=function(e){return t.hasPropWithPrefix(e,this.opt.path.options)};d.prototype.hasChangedEdgeTypes=function(e){if(t.hasPropWithPrefix(e,this.opt.path.edgeTypes)){return!!t.getMatches(this.view.getEdgeFilter("compiled"),Object.keys(e))}};d.prototype.hasChangedElements=function(e){var i=[];for(var s in e){if(t.isSystemOrDraft(s))continue;if(this.graphData.nodesById[this.adapter.getId(s)]){return true}if(e[s].modified){i.push(s)}}if(i.length){var r=this.view.getNodeFilter("compiled");var a=t.getMatches(r,i);return!!a.length}};d.prototype.initAndRenderGraph=function(e){this.logger("info","Initializing and rendering the graph");this.handleResizeEvent=this.handleResizeEvent.bind(this);this.handleClickEvent=this.handleClickEvent.bind(this);this.handleFullScreenChange=this.handleFullScreenChange.bind(this);window.addEventListener("resize",this.handleResizeEvent,false);if(!this.isContainedInSidebar){this.callbackManager.add("$:/state/sidebar",this.handleResizeEvent)}window.addEventListener("click",this.handleClickEvent,false);if(this.fsapi){window.addEventListener(this.fsapi["_fullscreenChange"],this.handleFullScreenChange,false)}this.handleResizeEvent();this.graphOptions=this.getGraphOptions();this.graphData={nodes:new o.DataSet,edges:new o.DataSet,nodesById:t.getDataMap(),edgesById:t.getDataMap()};this.network=new o.Network(this.graphDomNode,this.graphData,this.graphOptions);this.canvas=this.graphDomNode.getElementsByTagName("canvas")[0];this.visNetworkDomNode=this.graphDomNode.firstElementChild;this.addGraphKeyBindings(this.graphDomNode);for(var i in this.visHandlers){this.network.on(i,this.visHandlers[i].bind(this))}this.addGraphButtons({"fullscreen-button":function(){this.handleToggleFullscreen(false)}});if(this.isContainedInSidebar){this.addGraphButtons({"halfscreen-button":function(){this.handleToggleFullscreen(true)}})}this.rebuildGraph({resetFocus:{delay:0,duration:0}})};d.prototype.addGraphKeyBindings=function(e){this.visNetworkDomNode.tabIndex=0;this.graphKeydownHandler=function(e){if(e.keyCode===46){this.handleRemoveElements(this.network.getSelection())}else if(e.ctrlKey){if(e.keyCode===88){if(this.editorMode){this.handleAddNodesToClipboard("move")}else{this.notify("Map is read only!")}}else if(e.keyCode===67){this.handleAddNodesToClipboard("copy")}else if(e.keyCode===86){this.handlePasteNodesFromClipboard()}else if(e.keyCode===65){var t=Object.keys(this.graphData.nodesById);this.network.selectNodes(t)}e.preventDefault()}}.bind(this);e.addEventListener("keydown",this.graphKeydownHandler,true)};d.prototype.handlePasteNodesFromClipboard=function(){if(!this.editorMode||this.view.isLiveView()){this.notify("Map is read only!");return}if($tw.tmap.clipBoard){if($tw.tmap.clipBoard.type==="nodes"){var e=$tw.tmap.clipBoard.nodes;var t=Object.keys(e);if(t.length){for(var i in e){if(this.graphData.nodesById[i])continue;this.view.addNodeToView(e[i]);this.graphData.nodes.update({id:i})}this.network.selectNodes(t);this.notify("pasted "+t.length+" nodes into map.")}return}}this.notify("TiddlyMap clipboad is empty!")};d.prototype.handleAddNodesToClipboard=function(e){var t=this.network.getSelectedNodes();if(!t.length)return;$tw.tmap.clipBoard={type:"nodes",nodes:this.graphData.nodes.get(t,{returnType:"Object"})};this.notify("Copied "+t.length+" nodes to clipboard");if(e==="move"){for(var i=t.length;i--;){this.view.removeNodeFromFilter(t[i])}}};d.prototype.isMobileMode=function(){var e=t.getText(this.opt.ref.sidebarBreakpoint,960);return window.innerWidth<=parseInt(e)};d.prototype.getGraphOptions=function(){var e=this.opt.config.vis;var i=t.parseJSON(this.view.getConfig("vis"));var s=t.merge({},e,i);s.clickToUse=this.clickToUse;s.manipulation.enabled=!!this.editorMode;s.manipulation.deleteNode=function(e,t){this.handleRemoveElements(e);this.resetVisManipulationBar(t)}.bind(this);s.manipulation.deleteEdge=function(e,t){this.handleRemoveElements(e);this.resetVisManipulationBar(t)}.bind(this);s.manipulation.addEdge=function(e,t){this.handleConnectionEvent(e);this.resetVisManipulationBar(t)}.bind(this);s.manipulation.addNode=function(e,t){this.handleInsertNode(e);this.resetVisManipulationBar(t)}.bind(this);s.manipulation.editNode=function(e,t){this.handleEditNode(e);this.resetVisManipulationBar(t)}.bind(this);s.manipulation.editEdge=false;var r=s.physics;r[r.solver]=r[r.solver]||{};r.stabilization.iterations=this.view.getStabilizationIterations();this.logger("debug","Loaded graph options",s);return s};d.prototype.resetVisManipulationBar=function(e){if(e)e(null);this.network.disableEditMode();this.network.enableEditMode()};d.prototype.handleCreateView=function(){var e={view:this.view.getLabel()};this.dialogManager.open("createView",e,function(e,i){if(!e)return;var s=t.getText(i);var a=new r(s);if(a.exists()&&a.isLocked()){this.notify("Forbidden!");return}if(i&&i.fields.clone){a=new r(s,true,this.view)}else{a=new r(s,true)}this.setView(a)})};d.prototype.handleRenameView=function(){if(!this.view.isLocked()){var e=this.view.getReferences();var i={count:e.length.toString(),filter:t.joinAndWrap(e,"[[","]]")};this.dialogManager.open("getViewName",i,function(e,i){if(e){var s=t.getText(i);var a=new r(s);if(!s||a.isLocked()){this.notify("Forbidden!")}else{this.view.rename(s);this.setView(this.view)}}})}else{this.notify("Forbidden!")}};d.prototype.handleEditView=function(){var e=JSON.stringify(this.opt.config.vis);var i=this.graphData;var s={view:this.view.getLabel(),createdOn:this.view.getCreationDate(true),numberOfNodes:Object.keys(i.nodesById).length.toString(),numberOfEdges:Object.keys(i.edgesById).length.toString(),dialog:{preselects:$tw.utils.extend({},this.view.getConfig(),{"vis-inherited":e})}};var r="configureView";this.dialogManager.open(r,s,function(e,i){if(!e)return;var s=t.getPropertiesByPrefix(i.fields,"config.",true);this.view.setConfig(s);if(s["physics_mode"]&&!this.view.isEnabled("physics_mode")){this.handleStorePositions()}})};d.prototype.handleSaveCanvas=function(){var e="$:/temp/tmap/snapshot";var i=this.createAndSaveSnapshot(e);var s=t.getSnapshotTitle(this.view.getLabel(),"png");var r={dialog:{snapshot:e,width:this.canvas.width.toString(),height:this.canvas.height.toString(),preselects:{name:s,action:"download"}}};var a="saveCanvas";this.dialogManager.open(a,r,function(i,r){if(!i)return;s=r.fields.name||s;var a=r.fields.action;if(a==="download"){this.handleDownloadSnapshot(s)}else if(a==="wiki"){t.cp(e,s,true);this.dispatchEvent({type:"tm-navigate",navigateTo:s})}else if(a==="placeholder"){this.view.addPlaceholder(e)}$tw.wiki.deleteTiddler("$:/temp/tmap/snapshot")})};d.prototype.handleDownloadSnapshot=function(e){var i=this.document.createElement("a");var s=this.view.getLabel();i.download=e||t.getSnapshotTitle(s,"png");i.href=this.getSnapshot();var r=new MouseEvent("click");i.dispatchEvent(r)};d.prototype.createAndSaveSnapshot=function(e){var t=this.view.getLabel();var i=e||this.view.getRoot()+"/snapshot";$tw.wiki.addTiddler(new $tw.Tiddler({title:i,type:"image/png",text:this.getSnapshot(true),modified:new Date}));return i};d.prototype.getSnapshot=function(e){var i=this.canvas.toDataURL("image/png");return e?t.getWithoutPrefix(i,"data:image/png;base64,"):i};d.prototype.handleDeleteView=function(){var e=this.view.getLabel();if(this.view.isLocked()){this.notify("Forbidden!");return}var i=this.view.getReferences();if(i.length){var s={count:i.length.toString(),filter:t.joinAndWrap(i,"[[","]]")};this.dialogManager.open("cannotDeleteViewDialog",s);return}var r="You are about to delete the view "+"''"+e+"'' (no tiddler currently references this view).";this.openStandardConfirmDialog(function(t){if(t){this.view.destroy();this.setView(this.opt.misc.defaultViewLabel);this.logger("debug",'view "'+e+'" deleted ');this.notify('view "'+e+'" deleted ')}},r)};d.prototype.handleTriggeredRefresh=function(e){this.logger("log",e,"Triggered a refresh");this.rebuildGraph({resetData:false,resetOptions:false,resetFocus:{delay:1e3,duration:1e3}})};d.prototype.handleRemoveElements=function(e){if(e.nodes.length){this.handleRemoveNodes(e.nodes)}else if(e.edges.length){this.handleRemoveEdges(e.edges)}this.resetVisManipulationBar()};d.prototype.handleRemoveEdges=function(e){this.adapter.deleteEdges(this.graphData.edges.get(e));this.notify("edge"+(e.length>1?"s":"")+" removed");this.preventFitAfterRebuild=true};d.prototype.handleRemoveNodes=function(e){var t=this.adapter.getTiddlersById(e);var i={count:e.length.toString(),tiddlers:$tw.utils.stringifyList(t),dialog:{preselects:{"delete-from":"filter"}}};var s="deleteNodeDialog";this.dialogManager.open(s,i,function(t,i){if(!t)return;if(i.fields["delete-from"]==="system"){this.adapter.deleteNodes(e);var s=e.length}else{var s=0;for(var r=e.length;r--;){var a=this.view.removeNodeFromFilter(e[r]);if(a)s++}}this.preventFitAfterRebuild=true;this.notify("Removed "+s+" of "+e.length+" from "+i.fields["delete-from"])})};d.prototype.handleFullScreenChange=function(){if(this.fsapi&&this.enlargedMode==="fullscreen"&&!document[this.fsapi["_fullscreenElement"]]){this.handleToggleFullscreen()}};d.prototype.handleToggleFullscreen=function(e){this.logger("log","Toggled graph enlargement");if(this.enlargedMode){this.network.setOptions({clickToUse:this.clickToUse});t.findAndRemoveClassNames(["tmap-"+this.enlargedMode,"tmap-has-"+this.enlargedMode+"-child"]);if(this.enlargedMode==="fullscreen"){document[this.fsapi["_exitFullscreen"]]()}this.enlargedMode=null}else{if(!e&&!this.fsapi){this.dialogManager.open("fullscreenNotSupported");return}this.enlargedMode=this.isContainedInSidebar&&e?"halfscreen":"fullscreen";$tw.utils.addClass(this.domNode,"tmap-"+this.enlargedMode);var i=this.isContainedInSidebar?this.sidebar:t.getFirstElementByClassName("tc-story-river");$tw.utils.addClass(i,"tmap-has-"+this.enlargedMode+"-child");if(this.enlargedMode==="fullscreen"){this.document.documentElement[this.fsapi["_requestFullscreen"]](Element.ALLOW_KEYBOARD_INPUT)}this.notify("Activated "+this.enlargedMode+" mode");this.network.setOptions({clickToUse:false})}this.handleResizeEvent()};d.prototype.handleGenerateWidget=function(e){$tw.rootWidget.dispatchEvent({type:"tmap:tm-generate-widget",paramObject:{view:this.view.getLabel()}})};d.prototype.handleStorePositions=function(e){this.view.saveNodeData(this.network.getPositions());this.ignoreNextViewModification=true;if(e){this.notify("positions stored")}};d.prototype.handleEditFilters=function(){var e=t.getPrettyFilter(this.view.getNodeFilter("expression"));var i=t.getPrettyFilter(this.view.getEdgeFilter("expression"));var s={view:this.view.getLabel(),dialog:{preselects:{prettyNodeFilter:e,prettyEdgeFilter:i}}};this.dialogManager.open("editFilters",s,function(e,i){if(!e)return;this.view.setNodeFilter(t.getField(i,"prettyNodeFilter",""));this.view.setEdgeFilter(t.getField(i,"prettyEdgeFilter",""))})};d.prototype.handleVisStabilizedEvent=function(e){if(this.hasNetworkStabilized)return;this.hasNetworkStabilized=true;this.logger("log","Network stabilized after",e.iterations,"iterations");this.view.setStabilizationIterations(e.iterations);if(!this.view.isEnabled("physics_mode")){var t=this.graphData.nodesById;var i=[];for(var s in t){if(!t[s].x){i.push(s)}}if(i.length){this.setNodesMoveable(i,false);this.notify(i.length+" nodes were added to the graph");this.doFitAfterStabilize=true}var r=this.graphOptions.physics;r[r.solver].centralGravity=0;this.network.setOptions(this.graphOptions)}if(this.doFitAfterStabilize){this.doFitAfterStabilize=false;this.fitGraph(1e3,1e3)}};d.prototype.handleFocusNode=function(e){this.network.focus(this.adapter.getId(e.param),{scale:1.5,animation:true})};d.prototype.isZombieWidget=function(){if(this.domNode.isTiddlyWikiFakeDom===true){return true}else{return!this.document.body.contains(this.getContainer())}};d.prototype.fitGraph=function(e,t){window.clearTimeout(this.activeFitTimeout);t=t||0;e=e||0;var i=function(){if(this.isZombieWidget())return;this.network.redraw();this.network.fit({animation:{duration:t,easingFunction:"easeOutQuart"}})};this.activeFitTimeout=window.setTimeout(i.bind(this),e)};d.prototype.handleInsertNode=function(e){var i="getNodeTitle";this.dialogManager.open(i,null,function(i,s){if(!i)return;var r=t.getText(s);if(t.tiddlerExists(r)){if(t.isMatch(r,this.view.getNodeFilter("compiled"))){this.notify("Node already exists");return}else{e=this.adapter.makeNode(r,e);this.view.addNodeToView(e)}}else{e.label=r;this.adapter.insertNode(e,{view:this.view,editNodeOnCreate:false})}this.preventFitAfterRebuild=true})};d.prototype.handleEditNode=function(e){var i=$tw.tmap.indeces.tById[e.id];var s=t.getTiddler(i);var r=JSON.stringify(this.opt.config.vis);var a=this.view.getConfig("vis");var n=this.adapter.getInheritedNodeStyles([e.id]);var o=JSON.stringify(n[i]);var d=JSON.stringify(t.merge({},{color:s.fields["color"]},t.parseJSON(s.fields["tmap.style"])));var h=this.view.getLabel();var l={id:e.id};var p=this.view.getNodeData(e.id,true)||{};delete p.x;delete p.y;var g={view:h,tiddler:s.fields.title,tidColor:s.fields["color"],tidIcon:s.fields[this.opt.field.nodeIcon]||s.fields["tmap.fa-icon"],dialog:{preselects:{"inherited-global-default-style":r,"inherited-local-default-style":a,"inherited-group-styles":o,"global-node-style":d,"local-node-style":JSON.stringify(p)}}};this.dialogManager.open("editNode",g,function(s,r){if(!s)return;var a=r.fields["global-node-style"];t.setField(i,"tmap.style",a||null);var n=t.parseJSON(r.fields["local-node-style"]);this.view.saveNodeStyle(e.id,n);this.preventFitAfterRebuild=true})};d.prototype.handleVisSingleClickEvent=function(e){if(t.isTrue(this.opt.config.sys.singleClickMode)){this.handleOpenMapElementEvent(e)}};d.prototype.handleVisDoubleClickEvent=function(e){if(!e.nodes.length&&!e.edges.length){if(this.editorMode){this.handleInsertNode(e.pointer.canvas)}}else if(!t.isTrue(this.opt.config.sys.singleClickMode)){this.handleOpenMapElementEvent(e)}};d.prototype.handleOpenMapElementEvent=function(e){if(e.nodes.length){this.openTiddlerWithId(e.nodes[0])}else if(e.edges.length){this.logger("debug","Clicked on an Edge");var t=this.graphData.edgesById[e.edges[0]].type;this.handleEditEdgeType(t)}};d.prototype.handleEditEdgeType=function(e){if(!this.editorMode)return;var t=this.opt.config.sys.edgeClickBehaviour;if(t!=="manager")return;$tw.rootWidget.dispatchEvent({type:"tmap:tm-manage-edge-types",paramObject:{type:e}})};d.prototype.handleResizeEvent=function(e){if(this.isZombieWidget())return;var t=this.getAttr("height");if(!t&&this.isContainedInSidebar){var i=this.domNode.getBoundingClientRect().top;var s=parseInt(this.getAttr("bottom-spacing",25));var r=window.innerHeight-i;t=r-s+"px"}this.domNode.style["height"]=t||"300px";this.repaintGraph()};d.prototype.handleClickEvent=function(e){if(this.isZombieWidget()||!this.network)return;if(!this.graphDomNode.contains(e.target)){var t=this.network.getSelection();if(t.nodes.length||t.edges.length){this.logger("debug","Clicked outside; deselecting nodes/edges");this.network.selectNodes([]);this.resetVisManipulationBar()}}else{this.visNetworkDomNode.focus()}};d.prototype.handleVisOnContext=function(e){};d.prototype.handleVisSelectNode=function(e){this.assignSelectStyle(e.nodes)};d.prototype.assignSelectStyle=function(e){var i=this.graphOptions.nodes.color;for(var s=e.length;s--;){var r=e[s];var a=this.graphData.nodesById[r];this.graphData.nodes.update({id:r,color:{highlight:t.merge({},i,a.color)}})}};d.prototype.handleVisDeselectNode=function(e){};d.prototype.handleVisShowPopup=function(e){};d.prototype.handleVisDragEnd=function(e){if(!e.nodes.length)return;this.setNodesMoveable(e.nodes,false)};d.prototype.handleVisBeforeDrawing=function(e){};d.prototype.handleVisLoading=function(e){this.graphLoadingBarDomNode.style.display="block";var t="Loading "+Math.round(e.iterations/e.total*100)+"%";this.graphLoadingBarDomNode.innerHTML=t};d.prototype.handleVisLoadingDone=function(e){this.graphLoadingBarDomNode.style.display="none"};d.prototype.handleVisDragStart=function(e){if(e.nodes.length){this.assignSelectStyle(e.nodes);this.setNodesMoveable(e.nodes,true)}};d.prototype.destruct=function(){window.removeEventListener("resize",this.handleResizeEvent);window.removeEventListener("click",this.handleClickEvent);window.removeEventListener("click",this.handleFullScreenChange);this.graphDomNode.removeEventListener("keyup",this.graphKeydownHandler,true);if(this.network){this.network.destroy()}};d.prototype.openTiddlerWithId=function(e){var i=$tw.tmap.indeces.tById[e];this.logger("debug","Opening tiddler",i,"with id",e);if(this.enlargedMode==="fullscreen"){var s=this.wiki.findDraft(i);var r=!!s;if(!r){var a="tm-edit-tiddler";this.dispatchEvent({type:a,tiddlerTitle:i});s=this.wiki.findDraft(i)}var n={draftTRef:s};var o="fullscreenTiddlerEditor";this.dialogManager.open(o,n,function(e,a){if(e){var n="tm-save-tiddler";this.dispatchEvent({type:n,tiddlerTitle:s})}else if(!r){t.deleteTiddlers([s])}var n="tm-close-tiddler";this.dispatchEvent({type:n,tiddlerTitle:i})})}else{this.dispatchEvent({type:"tm-navigate",navigateTo:i})}};d.prototype.getViewHolderRef=function(){if(this.viewHolderRef){return this.viewHolderRef}this.logger("info","Retrieving or generating the view holder reference");var e=this.getAttr("view");if(e){this.logger("log",'User wants to bind view "'+e+'" to graph');var i=this.opt.path.views+"/"+e;if(this.wiki.getTiddler(i)){var s=this.opt.path.localHolders+"/"+t.genUUID();this.logger("log",'Created an independent temporary view holder "'+s+'"');this.wiki.addTiddler(new $tw.Tiddler({title:s,text:i}));this.logger("log",'View "'+i+'" inserted into independend holder')}else{this.logger("log",'View "'+e+'" does not exist')}}if(typeof s==="undefined"){this.logger("log","Using default (global) view holder");var s=this.opt.ref.defaultViewHolder}return s};d.prototype.setView=function(e,t){if(e){var i=new r(e).getLabel();t=t||this.viewHolderRef;this.logger("info","Inserting view '"+i+"' into holder '"+t+"'");this.wiki.addTiddler(new $tw.Tiddler({title:t,text:i}))}this.view=this.getView(true)};d.prototype.getView=function(e){if(!e&&this.view){return this.view}var i=this.getViewHolderRef();var s=new r(t.getText(i));this.logger("info",'Retrieved view "'+s.getLabel()+'" from holder "'+i+'"');if(s.exists()){return s}else{this.logger("log",'Warning: View "'+s.getLabel()+"\" doesn't exist. Default is used instead.");return new r("Default")}};d.prototype.getRefreshedDataSet=function(e,i,s){if(!s){return new o.DataSet(t.getValues(e))}if(i)s.remove(Object.keys(i));s.update(t.getValues(e));return s};d.prototype.repaintGraph=function(){if(this.network&&(!this.fsapi||!document[this.fsapi["_fullscreenElement"]]||this.enlargedMode)){this.logger("info","Repainting the whole graph");this.network.redraw();this.fitGraph(0,1e3)}};d.prototype.setGraphButtonEnabled=function(e,i){var s="vis-button"+" "+"tmap-"+e;var r=t.getFirstElementByClassName(s,this.domNode);$tw.utils.toggleClass(r,"tmap-button-enabled",i)};d.prototype.dialogPostProcessor=function(){this.network.selectNodes([]);this.resetVisManipulationBar()};d.prototype.setNodesMoveable=function(e,t){if(!e||!e.length||this.view.isEnabled("physics_mode")){return}var i=[];var s=!t;for(var r=e.length;r--;){i.push({id:e[r],fixed:{x:s,y:s}})}this.graphData.nodes.update(i);if(s){this.logger("debug","Fixing",i.length,"nodes");this.handleStorePositions()}};d.prototype.addGraphButtons=function(e){var i=t.getFirstElementByClassName("vis-navigation",this.domNode);for(var s in e){var r=this.document.createElement("div");r.className="vis-button "+" "+"tmap-"+s;r.addEventListener("click",e[s].bind(this),false);i.appendChild(r);this.setGraphButtonEnabled(s,true)}};if($tw.boot.tasks.trapErrors){var h=window.onerror;window.onerror=function(e,t,i){if(e.indexOf("NS_ERROR_NOT_AVAILABLE")!==-1&&t=="$:/plugins/felixhayashi/vis/vis.js"){console.error("Strange firefox related vis.js error (see #125)",arguments)}else if(e.indexOf("Permission denied to access property")!==-1){console.error("Strange firefox related vis.js error (see #163)",arguments)}else if(h){h.apply(this,arguments)}}}exports.tiddlymap=d})();