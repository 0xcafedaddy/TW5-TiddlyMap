/*\

title: $:/plugins/felixhayashi/tiddlymap/js/DialogManager
type: application/javascript
module-type: library

@module TiddlyMap
@preserve

\*/
(function(){"use strict";var t=require("$:/plugins/felixhayashi/tiddlymap/js/utils").utils;var e=require("$:/plugins/felixhayashi/tiddlymap/js/CallbackManager").CallbackManager;var i=function(t,e){this.logger=$tw.tmap.logger;this.adapter=$tw.tmap.adapter;this.opt=$tw.tmap.opt;this.callbackManager=t;if(e){this.context=e}};i.prototype.open=function(e,i,a){if(t.isTrue(this.opt.config.sys.suppressedDialogs[e],false)){this.logger("warning","Suppressed dialog",e);return}i=i||{};this.logger("debug","Dialog param object",i);if(typeof a==="function"&&this.context){a=a.bind(this.context)}var l=this.opt.path.tempRoot+"/dialog-"+t.genUUID();var r=t.getTiddler(this.opt.path.dialogs+"/"+e);var s={title:l,buttons:r.fields["buttons"]||"ok_cancel",classes:"tmap-modal-content "+r.fields["classes"],output:l+"/output",result:l+"/result",temp:l+"/temp",template:r.fields.title,templateId:e,currentTiddler:l+"/output",text:t.getText(this.opt.path.dialogs)};if(i.dialog){if(i.dialog.preselects){$tw.wiki.addTiddler(new $tw.Tiddler({title:s.output},t.flatten(i.dialog.preselects)));delete i.dialog.preselects}t.merge(s,i.dialog)}s.footer=t.getText(this.opt.path.footers);s=t.flatten(s);i=t.flatten(i);var o=function(e){this.getElement("hidden-close-button").click();var i=$tw.wiki.getTiddler(e);var r=i.fields.text;if(r){var o=$tw.wiki.getTiddler(s.output)}else{var o=null;$tw.tmap.notify("operation cancelled")}if(typeof a==="function"){a(r,o)}t.deleteByPrefix(l)}.bind(this);this.callbackManager.add(s.result,o,true);var n=new $tw.Tiddler(r,i,s);$tw.wiki.addTiddler(n);this.logger("debug","Opening dialog",n);$tw.rootWidget.dispatchEvent({type:"tm-modal",param:n.fields.title,paramObject:n.fields});this.addKeyBindings();return n};i.prototype.getElement=function(e){return t.getFirstElementByClassName("tmap-"+e)};i.prototype.addKeyBindings=function(){var e=$tw.tmap.keycharm({container:t.getFirstElementByClassName("tc-modal")});var i=/tmap-triggers-(.+?)-on-(.+?)(?:\s|$)/;var a=document.getElementsByClassName("tmap-trigger-field");for(var l=a.length;l--;){var r=a[l].className.split(" ");for(var s=r.length;s--;){var o=r[s].match(i);if(!o){continue}var n=o[1];var d=o[2];var p=this.getElement(n);if(!p)continue;e.bind(d,function(){this.click()}.bind(p))}}};exports.DialogManager=i})();