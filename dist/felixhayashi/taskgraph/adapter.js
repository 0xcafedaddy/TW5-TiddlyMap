/*\

title: $:/plugins/felixhayashi/taskgraph/adapter.js
type: application/javascript
module-type: library

@preserve

\*/
var utils=require("$:/plugins/felixhayashi/taskgraph/utils.js").utils,ViewAbstraction=require("$:/plugins/felixhayashi/taskgraph/view_abstraction.js").ViewAbstraction,vis=require("$:/plugins/felixhayashi/vis/vis.js"),Adapter=function(t){this.wiki=t?t:$tw.wiki,this.opt=$tw.taskgraph.opt,this.logger=$tw.taskgraph.logger};Adapter.prototype.insertEdge=function(t,e){if("object"==typeof t&&t.from&&t.to){e=new ViewAbstraction(e);var i=t.label?t.label:this.opt.misc.unknownEdgeLabel,r=e.getEdgeStoreLocation()+"/"+i,s=this.wiki.getTiddlerData(r,[]);if(this.logger("info",'Inserting edge into store  "'+r+'"',t),delete t.label,t.id){var o=utils.keyOfItemWithProperty(s,"id",t.id);"undefined"==typeof o&&(o=s.length)}else{t.id=utils.genUUID();var o=s.length}s[o]=t;var a={},d=this.wiki.getTiddler(r);d&&d.fields.id||(a.id=utils.genUUID()),this.wiki.setTiddlerData(r,s,a),t.label=i,$tw.taskgraph.edgeChanges.push({type:"insert",edge:t})}},Adapter.prototype.selectEdgesByFilter=function(t,e){for(var i=utils.getMatches(t),r=[],s=0;s<i.length;s++)r.push(utils.getBasename(i[s]));return this.selectEdgesByLabel(r,e)},Adapter.prototype.selectEdgesByLabel=function(t,e){"object"!=typeof e&&(e=utils.getEmptyMap());for(var i=new ViewAbstraction(e.view),r=i.getEdgeStoreLocation(),s=utils.getEmptyMap(),o=0;o<t.length;o++){var a=r+"/"+t[o];if(utils.tiddlerExists(a))for(var d=this.wiki.getTiddlerData(a),l=0;l<d.length;l++)t[o]!==this.opt.misc.unknownEdgeLabel&&(d[l].label=t[o]),s[d[l].id]=d[l]}return utils.convert(s,e.outputType)},Adapter.prototype.selectEdgesByEndpoints=function(t,e){"object"!=typeof e&&(e=utils.getEmptyMap());var i=new ViewAbstraction(e.view),r=i.exists()?e.view.getEdgeFilter("compiled"):this.opt.filter.allSharedEdges,s=this.selectEdgesByFilter(r,{outputType:"array",view:i});return this.filterEdgesByEndpoints(s,t,e)},Adapter.prototype.filterEdgesByEndpoints=function(t,e,i){"object"!=typeof i&&(i=utils.getEmptyMap()),t=utils.convert(t,"array");for(var r=/^(=1|>=1|=2)$/,s=r.test(i.endpointsInSet)?i.endpointsInSet:">=1",e=utils.getLookupTable(e,"id"),o=utils.getEmptyMap(),a=0;a<t.length;a++){var d=t[a];switch(s){case"=2":isMatch=e[d.from];break;case">=1":isMatch=e[d.from]||e[d.to];break;case"=1":isMatch=void 0===e[d.from]&&e[d.to]||void 0===e[d.to]&&e[d.from];break;default:isMatch=!1}isMatch&&(o[d.id]=d)}return utils.convert(o,i.outputType)},Adapter.prototype.selectNodesByFilter=function(t,e){var i=utils.getMatches(t);return this.selectNodesByReference(i,e)},Adapter.prototype.selectNodesByReference=function(t,e){"object"!=typeof e&&(e=utils.getEmptyMap());for(var i=e.addProperties,r=utils.getEmptyMap(),s=0;s<t.length;s++)if(!this.wiki.isSystemTiddler(t[s])){var o=this.setupTiddler(t[s]);if(o){var a=o.fields[this.opt.field.nodeId];if(!r[a]){var d=utils.getEmptyMap();"object"==typeof i&&(d=$tw.utils.extendDeepCopy(d,i)),d.id=a,d.label=o.fields.title,r[a]=d}}}return e.view&&this._restorePositions(r,e.view),utils.convert(r,e.outputType)},Adapter.prototype.selectNeighbours=function(t,e){if("object"!=typeof e&&(e=utils.getEmptyMap()),e.edges)var i=this.filterEdgesByEndpoints(e.edges,t,{outputType:"array",endpointsInSet:"=1"});else var i=this.selectEdgesByEndpoints(t,{outputType:"array",view:e.view,endpointsInSet:"=1"});for(var t=utils.getLookupTable(t,"id"),r=utils.getEmptyMap(),s=0;s<i.length;s++){var o=t[i[s].from]?i[s].to:i[s].from;r[o]=!0}return this.selectNodesByIds(r,e)},Adapter.prototype.selectNodesByIds=function(t,e){"object"!=typeof e&&(e=utils.getEmptyMap()),Array.isArray(t)?t=utils.getArrayValuesAsHashmapKeys(t):t instanceof vis.DataSet&&(t=utils.getLookupTable(t,"id"));var i=utils.getEmptyMap(),r=this.wiki.allTitles(),s=this.opt.field.nodeId,o=e.addProperties;for(var a in t)for(var d=0;d<r.length;d++){var l=this.wiki.getTiddler(r[d]),a=l.fields[s];if(!l.isDraft()&&!this.wiki.isSystemTiddler(r[d])&&t[a]){var n=utils.getEmptyMap();"object"==typeof o&&(n=$tw.utils.extendDeepCopy(n,o)),n.id=a,n.label=l.fields.title,i[a]=n}}return e.view&&this._restorePositions(i,e.view),utils.convert(i,e.outputType)},Adapter.prototype.selectNodeById=function(t,e){"object"!=typeof e&&(e=utils.getEmptyMap()),e.outputType="hashmap";var i=this.selectNodesByIds([t],e);return i[t]},Adapter.prototype.deleteNodesFromStore=function(t){if(t){var e=this.opt.field.nodeId,i=this.wiki.allTitles(),r=[],t=utils.getLookupTable(t,"id");for(var s in t)for(var o=0;o<i.length;o++){var a=utils.getTiddlersWithProperty(e,s,{isIncludeDrafts:!0,isReturnRef:!0,tiddlers:i});r=r.concat(a)}var d=this.wiki.getTiddlerList("$:/StoryList");if(d.length){d=d.filter(function(t){return-1==r.indexOf(t)});var l=this.wiki.getTiddler("$:/StoryList");this.wiki.addTiddler(new $tw.Tiddler(l,{list:d}))}utils.deleteTiddlers(r)}},Adapter.prototype.deleteEdgeFromStore=function(t,e){if(t){var i=t.label?t.label:this.opt.misc.unknownEdgeLabel,e=new ViewAbstraction(e),r=e.getEdgeStoreLocation()+"/"+i,s=this.wiki.getTiddlerData(r,[]);this.logger("info",'Edge with label "'+i+'" will be deleted: '+t);var o=utils.keyOfItemWithProperty(s,"id",t.id);null!=o&&(s.splice(o,1),this.wiki.setTiddlerData(r,s),$tw.taskgraph.edgeChanges.push({type:"delete",edge:t}))}},Adapter.prototype.deleteEdgesFromStore=function(t,e){t=utils.convert(t,"array");for(var i=0;i<t.length;i++)this.deleteEdgeFromStore(t[i],e)},Adapter.prototype.getView=function(t,e){return new ViewAbstraction(t,e)},Adapter.prototype.createView=function(t){("string"!=typeof t||""===t)&&(t="My view");var e=this.wiki.generateNewTitle(this.opt.path.views+"/"+t);return new ViewAbstraction(e,!0)},Adapter.prototype._restorePositions=function(t,e){if(e=new ViewAbstraction(e),e.exists()){var i=e.getPositions();for(var r in t)utils.hasOwnProp(i,r)&&(t[r].x=i[r].x,t[r].y=i[r].y)}},Adapter.prototype.storePositions=function(t,e){e=new ViewAbstraction(e),e.setPositions(t)},Adapter.prototype.setupTiddler=function(t){var e=this.wiki.getTiddler(utils.getTiddlerReference(t));if(e){var i=this.opt.field.nodeId;if(!e.fields[i]){var r=utils.getEmptyMap();r[i]=utils.genUUID(),e=new $tw.Tiddler(e,r),$tw.wiki.addTiddler(e)}return e}},Adapter.prototype.insertNode=function(t,e){"object"!=typeof e&&(e=utils.getEmptyMap()),"object"!=typeof t&&(t=utils.getEmptyMap()),"string"!=typeof t.label&&(t.label="New node"),t.id||(t.id=utils.genUUID());var i=utils.getEmptyMap();if(i.title=this.wiki.generateNewTitle(t.label),i[this.opt.field.nodeId]=t.id,e.view){var r=new ViewAbstraction(e.view);r.setNodePosition(t);var s="[field:"+this.opt.field.nodeId+"["+t.id+"]]";r.appendToNodeFilter(s)}return this.wiki.addTiddler(new $tw.Tiddler(i)),t},exports.Adapter=Adapter;