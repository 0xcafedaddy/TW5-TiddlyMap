{"version":3,"sources":["felixhayashi/tiddlymap/js/services/Fixer.js"],"names":["_utils","require","_ViewAbstraction","_EdgeType","_NodeType","_environment","env","Fixer","adapter","logger","glNTy","_classCallCheck","this","wiki","$tw","path","view","matches","_utils2","default","getTiddlersByPrefix","i","length","type","getBasename","_EdgeType2","exists","save","edges","j","id","deleteTiddler","upgrade","isLeftVersionGreater","toVersion","curVersion","msg","ref","sysMeta","meta","getTiddlerData","executeUpgrade","dataStructureState","originalVersion","userConf","nodeIdField","getEntry","moveFieldValues","_this","moveEdges","filter","selector","allViews","getMatches","viewRefs","_ViewAbstraction2","getRoot","liveView","setNodeFilter","setConfig","refresh-trigger","refresh-triggers","utils","confRef","visUserConf","unflatten","_typeof","groups","setStyle","setTiddlerData","fixId","liveTab","getTiddler","hasTag","setField","views","eTyFilter","getEdgeTypeFilter","confKey","f","edgeTypePath","edgeTypes","replaceAll","setEdgeTypeFilter"],"mappings":"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","file":"../../../../../felixhayashi/tiddlymap/js/services/Fixer.js","sourcesContent":["// @preserve\n/*\\\n\ntitle: $:/plugins/felixhayashi/tiddlymap/js/Fixer\ntype: application/javascript\nmodule-type: library\n\n@preserve\n\n\\*/\n\n/*** Imports *******************************************************/\n\nimport utils           from '$:/plugins/felixhayashi/tiddlymap/js/utils';\nimport ViewAbstraction from '$:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction';\nimport EdgeType        from '$:/plugins/felixhayashi/tiddlymap/js/EdgeType';\nimport NodeType        from '$:/plugins/felixhayashi/tiddlymap/js/NodeType';\nimport * as env        from '$:/plugins/felixhayashi/tiddlymap/js/lib/environment';\n\n/*** Code **********************************************************/\n\nclass Fixer {\n\n  /**\n   * @param {Adapter} adapter\n   * @param {Object} logger\n   * @param {Object} glNTy\n   */\n  constructor(adapter, logger, glNTy) {\n\n    this.adapter = adapter;\n    this.logger = logger;\n    this.wiki = $tw.wiki;\n    this.glNTy = glNTy;\n\n  }\n\n  moveEdges(path, view) {\n\n    const matches = utils.getTiddlersByPrefix(path);\n    for (let i = 0; i < matches.length; i++) {\n\n      // create edge type\n      let type = utils.getBasename(matches[i]);\n\n      if (type === '__noname__') {\n        type = 'tmap:unknown';\n      }\n\n      type = new EdgeType(type);\n\n      if (!type.exists()) {\n        type.save();\n      }\n\n      // move edges\n      const edges = this.wiki.getTiddlerData(matches[i]);\n      for (let j = 0; j < edges.length; j++) {\n        // prefix formerly private edges with view name as namespace\n        edges[j].type = (view ? view + ':' : '') + type.id;\n        this.adapter.insertEdge(edges[j]);\n      }\n\n      // finally remove the store\n      this.wiki.deleteTiddler(matches[i]);\n\n    }\n\n  }\n\n  executeUpgrade(toVersion, curVersion, upgrade) {\n\n    if (!utils.isLeftVersionGreater(toVersion, curVersion)) {\n      // = current data structure version is newer than version we want to upgrade to.\n      return;\n    }\n\n    // issue debug message\n    this.logger('debug', `Upgrading data structure to ${toVersion}`);\n    // execute fix\n    const msg = upgrade();\n    // update meta\n    utils.setEntry(env.ref.sysMeta, 'dataStructureState', toVersion);\n\n    return msg;\n\n  };\n\n  /**\n   * Special fix that is not invoked along with the other fixes but\n   * when creating the index (see caretaker code).\n   *\n   * Changes:\n   * 1. The node id field is moved to tmap.id if **original version**\n   *    is below v0.9.2.\n   */\n  fixId() {\n\n    const meta = this.wiki.getTiddlerData(env.ref.sysMeta, {});\n\n    this.executeUpgrade('0.9.2', meta.dataStructureState, () => {\n\n      if (utils.isLeftVersionGreater('0.9.2', meta.originalVersion)) {\n        // path of the user conf at least in 0.9.2\n        const userConf = '$:/plugins/felixhayashi/tiddlymap/config/sys/user';\n        const nodeIdField = utils.getEntry(userConf, 'field.nodeId', 'tmap.id');\n        utils.moveFieldValues(nodeIdField, 'tmap.id', true, false);\n      }\n    });\n\n  };\n\n  fix() {\n\n    const meta = this.wiki.getTiddlerData(env.ref.sysMeta, {});\n\n    this.logger('debug', 'Fixer is started');\n    this.logger('debug', 'Data-structure currently in use: ', meta.dataStructureState);\n\n    /**\n     * Changes:\n     * 1. Edges are stored in tiddlers instead of type based edge stores\n     * 2. No more private views\n     */\n    this.executeUpgrade('0.7.0', meta.dataStructureState, () => {\n\n      // move edges that were formerly \"global\"\n      this.moveEdges('$:/plugins/felixhayashi/tiddlymap/graph/edges', null);\n\n      // move edges that were formerly bound to view (\"private\")\n      const filter = env.selector.allViews;\n      const viewRefs = utils.getMatches(filter);\n      for (let i = 0; i < viewRefs.length; i++) {\n        const view = new ViewAbstraction(viewRefs[i]);\n        this.moveEdges(`${view.getRoot()}/graph/edges`, view);\n      }\n\n    });\n\n    /**\n     * Changes:\n     * 1. Changes to the live view filter and refresh trigger field\n     */\n    this.executeUpgrade('0.7.32', meta.dataStructureState, () => {\n\n      const liveView = new ViewAbstraction('Live View');\n\n      if (!liveView.exists()) {\n        return;\n      }\n\n      // Only listen to the current tiddler of the history list\n      liveView.setNodeFilter('[field:title{$:/temp/tmap/currentTiddler}]', true);\n\n      liveView.setConfig({\n        'refresh-trigger': null, // delete the field (renamed)\n        'refresh-triggers': $tw.utils.stringifyList([ '$:/temp/tmap/currentTiddler' ]),\n      });\n\n    });\n\n    /**\n     * Changes:\n     * 1. Group styles for matches and neighbours are now modulized\n     *    and stored as node-types.\n     * 2. vis user configuration is restored unflattened!\n     *    The user only interacts through the GUI.\n     * 3. If the node id field was \"id\" it is moved to tmap.id\n     */\n    this.executeUpgrade('0.9.0', meta.dataStructureState, () => {\n\n      const confRef = env.ref.visUserConf;\n      const userConf = utils.unflatten(this.wiki.getTiddlerData(confRef, {}));\n\n      if (typeof userConf.groups === 'object') {\n\n        const type = new NodeType('tmap:neighbour');\n        type.setStyle(userConf.groups[ 'neighbours' ]);\n        type.save();\n\n        delete userConf.groups;\n        this.wiki.setTiddlerData(confRef, userConf);\n\n      }\n\n    });\n\n    /**\n     * Changes:\n     * 1. The node id field is moved to tmap.id if **original version**\n     *    is below v0.9.2.\n     */\n    this.fixId();\n\n\n    /**\n     * This will ensure that all node types have a prioritization field\n     * set.\n     */\n    this.executeUpgrade('0.9.16', meta.dataStructureState, () => {\n\n      for (let i = this.glNTy.length; i--;) {\n        this.glNTy[i].save(null, true);\n      }\n\n    });\n\n    /**\n     * Fixes the live tab\n     */\n    this.executeUpgrade('0.10.3', meta.dataStructureState, function () {\n\n      const liveTab = env.ref.liveTab;\n      if (utils.getTiddler(liveTab).hasTag('$:/tags/SideBar')) {\n        this.wiki.deleteTiddler(liveTab);\n        utils.setField(liveTab, 'tags', '$:/tags/SideBar');\n      }\n\n    });\n\n    /**\n     * 1) Fixes the edge type filter. Before, an empty filter was\n     * treated as default filter, i.e. no links and tags shown.\n     * Now an empty filter means that we show all edge types.\n     *\n     * 2) Adds prefix to hide private edges per default\n     *\n     * 3) Corrects view-namespaces (formerly stored with colon).\n     *\n     */\n    this.executeUpgrade('0.11.0', meta.dataStructureState, function () {\n\n      const views = utils.getMatches(env.selector.allViews);\n\n      for (let i = views.length; i--;) {\n\n        const view = new ViewAbstraction(views[i]);\n        let eTyFilter = view.getEdgeTypeFilter('raw');\n        const confKey = 'edge_type_namespace';\n        view.setConfig(confKey, view.getConfig(confKey));\n\n        let f = env.filter.defaultEdgeTypeFilter;\n\n        if (eTyFilter) {\n\n          // remove any occurences of the egde type path prefix\n          const edgeTypePath = env.path.edgeTypes;\n          eTyFilter = utils.replaceAll(eTyFilter, '', [\n            edgeTypePath,\n            edgeTypePath + '/',\n            '[prefix[' + edgeTypePath + ']]',\n            '[prefix[' + edgeTypePath + '/]]',\n            [ '[suffix[tw-body:link]]', '[[tw-body:link]]' ],\n            [ '[suffix[tw-list:tags]]', '[[tw-list:tags]]' ],\n            [ '[suffix[tw-list:list]]', '[[tw-body:list]]' ],\n            [ '[suffix[tmap:unknown]]', '[[tmap:unknown]]' ],\n            [ '[suffix[unknown]]', '[[tmap:unknown]]' ],\n          ]);\n\n          f = '-[prefix[_]] ' + eTyFilter;\n\n        }\n\n        view.setEdgeTypeFilter(f);\n      }\n\n    });\n\n  };\n}\n\n/*** Exports *******************************************************/\n\nexport default Fixer;\n\n"],"sourceRoot":"../../../../../../src/plugins"}